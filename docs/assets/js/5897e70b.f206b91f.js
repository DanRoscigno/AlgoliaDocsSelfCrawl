"use strict";(self.webpackChunkclickhouse_docs_2_3_0=self.webpackChunkclickhouse_docs_2_3_0||[]).push([[34245],{3905:(e,t,a)=>{a.d(t,{Zo:()=>b,kt:()=>d});var n=a(67294);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var o=n.createContext({}),m=function(e){var t=n.useContext(o),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},b=function(e){var t=m(e.components);return n.createElement(o.Provider,{value:t},e.children)},u="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},c=n.forwardRef((function(e,t){var a=e.components,i=e.mdxType,r=e.originalType,o=e.parentName,b=s(e,["components","mdxType","originalType","parentName"]),u=m(a),c=i,d=u["".concat(o,".").concat(c)]||u[c]||p[c]||r;return a?n.createElement(d,l(l({ref:t},b),{},{components:a})):n.createElement(d,l({ref:t},b))}));function d(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=a.length,l=new Array(r);l[0]=c;var s={};for(var o in t)hasOwnProperty.call(t,o)&&(s[o]=t[o]);s.originalType=e,s[u]="string"==typeof e?e:i,l[1]=s;for(var m=2;m<r;m++)l[m]=a[m];return n.createElement.apply(null,l)}return n.createElement.apply(null,a)}c.displayName="MDXCreateElement"},17:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>o,contentTitle:()=>l,default:()=>p,frontMatter:()=>r,metadata:()=>s,toc:()=>m});var n=a(87462),i=(a(67294),a(3905));const r={slug:"/en/engines/table-engines/integrations/rabbitmq",sidebar_position:10,sidebar_label:"RabbitMQ"},l="RabbitMQ Engine",s={unversionedId:"en/engines/table-engines/integrations/rabbitmq",id:"en/engines/table-engines/integrations/rabbitmq",title:"RabbitMQ Engine",description:"This engine allows integrating ClickHouse with RabbitMQ.",source:"@site/docs/en/engines/table-engines/integrations/rabbitmq.md",sourceDirName:"en/engines/table-engines/integrations",slug:"/en/engines/table-engines/integrations/rabbitmq",permalink:"/AlgoliaDocsSelfCrawl/en/engines/table-engines/integrations/rabbitmq",draft:!1,editUrl:"https://github.com/ClickHouse/ClickHouse/tree/master/docs/en/engines/table-engines/integrations/rabbitmq.md",tags:[],version:"current",sidebarPosition:10,frontMatter:{slug:"/en/engines/table-engines/integrations/rabbitmq",sidebar_position:10,sidebar_label:"RabbitMQ"},sidebar:"english",previous:{title:"EmbeddedRocksDB",permalink:"/AlgoliaDocsSelfCrawl/en/engines/table-engines/integrations/embedded-rocksdb"},next:{title:"PostgreSQL",permalink:"/AlgoliaDocsSelfCrawl/en/engines/table-engines/integrations/postgresql"}},o={},m=[{value:"Creating a Table",id:"table_engine-rabbitmq-creating-a-table",level:2},{value:"Description",id:"description",level:2},{value:"Virtual Columns",id:"virtual-columns",level:2},{value:"Data formats support",id:"data-formats-support",level:2}],b={toc:m},u="wrapper";function p(e){let{components:t,...a}=e;return(0,i.kt)(u,(0,n.Z)({},b,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"rabbitmq-engine"},"RabbitMQ Engine"),(0,i.kt)("p",null,"This engine allows integrating ClickHouse with ",(0,i.kt)("a",{parentName:"p",href:"https://www.rabbitmq.com"},"RabbitMQ"),"."),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"RabbitMQ")," lets you:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Publish or subscribe to data flows."),(0,i.kt)("li",{parentName:"ul"},"Process streams as they become available.")),(0,i.kt)("h2",{id:"table_engine-rabbitmq-creating-a-table"},"Creating a Table"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE TABLE [IF NOT EXISTS] [db.]table_name [ON CLUSTER cluster]\n(\n    name1 [type1] [DEFAULT|MATERIALIZED|ALIAS expr1],\n    name2 [type2] [DEFAULT|MATERIALIZED|ALIAS expr2],\n    ...\n) ENGINE = RabbitMQ SETTINGS\n    rabbitmq_host_port = 'host:port' [or rabbitmq_address = 'amqp(s)://guest:guest@localhost/vhost'],\n    rabbitmq_exchange_name = 'exchange_name',\n    rabbitmq_format = 'data_format'[,]\n    [rabbitmq_exchange_type = 'exchange_type',]\n    [rabbitmq_routing_key_list = 'key1,key2,...',]\n    [rabbitmq_secure = 0,]\n    [rabbitmq_row_delimiter = 'delimiter_symbol',]\n    [rabbitmq_schema = '',]\n    [rabbitmq_num_consumers = N,]\n    [rabbitmq_num_queues = N,]\n    [rabbitmq_queue_base = 'queue',]\n    [rabbitmq_deadletter_exchange = 'dl-exchange',]\n    [rabbitmq_persistent = 0,]\n    [rabbitmq_skip_broken_messages = N,]\n    [rabbitmq_max_block_size = N,]\n    [rabbitmq_flush_interval_ms = N,]\n    [rabbitmq_queue_settings_list = 'x-dead-letter-exchange=my-dlx,x-max-length=10,x-overflow=reject-publish',]\n    [rabbitmq_queue_consume = false,]\n    [rabbitmq_address = '',]\n    [rabbitmq_vhost = '/',]\n    [rabbitmq_queue_consume = false,]\n    [rabbitmq_username = '',]\n    [rabbitmq_password = '',]\n    [rabbitmq_commit_on_select = false,]\n    [rabbitmq_max_rows_per_message = 1]\n")),(0,i.kt)("p",null,"Required parameters:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_host_port")," \u2013 host:port (for example, ",(0,i.kt)("inlineCode",{parentName:"li"},"localhost:5672"),")."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_exchange_name")," \u2013 RabbitMQ exchange name."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_format")," \u2013 Message format. Uses the same notation as the SQL ",(0,i.kt)("inlineCode",{parentName:"li"},"FORMAT")," function, such as ",(0,i.kt)("inlineCode",{parentName:"li"},"JSONEachRow"),". For more information, see the ",(0,i.kt)("a",{parentName:"li",href:"/AlgoliaDocsSelfCrawl/en/interfaces/formats"},"Formats")," section.")),(0,i.kt)("p",null,"Optional parameters:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_exchange_type")," \u2013 The type of RabbitMQ exchange: ",(0,i.kt)("inlineCode",{parentName:"li"},"direct"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"fanout"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"topic"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"headers"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"consistent_hash"),". Default: ",(0,i.kt)("inlineCode",{parentName:"li"},"fanout"),"."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_routing_key_list")," \u2013 A comma-separated list of routing keys."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_row_delimiter")," \u2013 Delimiter character, which ends the message. ",(0,i.kt)("strong",{parentName:"li"},"This setting is deprecated and is no longer used, not left for compatibility reasons.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_schema")," \u2013 Parameter that must be used if the format requires a schema definition. For example, ",(0,i.kt)("a",{parentName:"li",href:"https://capnproto.org/"},"Cap\u2019n Proto")," requires the path to the schema file and the name of the root ",(0,i.kt)("inlineCode",{parentName:"li"},"schema.capnp:Message")," object."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_num_consumers")," \u2013 The number of consumers per table. Specify more consumers if the throughput of one consumer is insufficient. Default: ",(0,i.kt)("inlineCode",{parentName:"li"},"1")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_num_queues")," \u2013 Total number of queues. Increasing this number can significantly improve performance. Default: ",(0,i.kt)("inlineCode",{parentName:"li"},"1"),"."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_queue_base")," - Specify a hint for queue names. Use cases of this setting are described below."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_deadletter_exchange")," - Specify name for a ",(0,i.kt)("a",{parentName:"li",href:"https://www.rabbitmq.com/dlx.html"},"dead letter exchange"),". You can create another table with this exchange name and collect messages in cases when they are republished to dead letter exchange. By default dead letter exchange is not specified."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_persistent")," - If set to 1 (true), in insert query delivery mode will be set to 2 (marks messages as 'persistent'). Default: ",(0,i.kt)("inlineCode",{parentName:"li"},"0"),"."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_skip_broken_messages")," \u2013 RabbitMQ message parser tolerance to schema-incompatible messages per block. If ",(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_skip_broken_messages = N")," then the engine skips ",(0,i.kt)("em",{parentName:"li"},"N")," RabbitMQ messages that cannot be parsed (a message equals a row of data). Default: ",(0,i.kt)("inlineCode",{parentName:"li"},"0"),"."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_max_block_size")," - Number of row collected before flushing data from RabbitMQ. Default: ",(0,i.kt)("a",{parentName:"li",href:"/AlgoliaDocsSelfCrawl/en/operations/settings/settings#setting-max_insert_block_size"},"max_insert_block_size"),"."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_flush_interval_ms")," - Timeout for flushing data from RabbitMQ. Default: ",(0,i.kt)("a",{parentName:"li",href:"/AlgoliaDocsSelfCrawl/en/operations/settings/settings#stream-flush-interval-ms"},"stream_flush_interval_ms"),"."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_queue_settings_list")," - allows to set RabbitMQ settings when creating a queue. Available settings: ",(0,i.kt)("inlineCode",{parentName:"li"},"x-max-length"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"x-max-length-bytes"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"x-message-ttl"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"x-expires"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"x-priority"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"x-max-priority"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"x-overflow"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"x-dead-letter-exchange"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"x-queue-type"),". The ",(0,i.kt)("inlineCode",{parentName:"li"},"durable")," setting is enabled automatically for the queue."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_address")," - Address for connection. Use ether this setting or ",(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_host_port"),"."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_vhost")," - RabbitMQ vhost. Default: ",(0,i.kt)("inlineCode",{parentName:"li"},"'\\'"),"."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_queue_consume")," - Use user-defined queues and do not make any RabbitMQ setup: declaring exchanges, queues, bindings. Default: ",(0,i.kt)("inlineCode",{parentName:"li"},"false"),"."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_username")," - RabbitMQ username."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_password")," - RabbitMQ password."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_commit_on_select")," - Commit messages when select query is made. Default: ",(0,i.kt)("inlineCode",{parentName:"li"},"false"),"."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_max_rows_per_message")," \u2014 The maximum number of rows written in one RabbitMQ message for row-based formats. Default : ",(0,i.kt)("inlineCode",{parentName:"li"},"1"),"."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_empty_queue_backoff_start")," \u2014 A start backoff point to reschedule read if the rabbitmq queue is empty."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_empty_queue_backoff_end")," \u2014 An end backoff point to reschedule read if the rabbitmq queue is empty.")),(0,i.kt)("ul",{className:"contains-task-list"},(0,i.kt)("li",{parentName:"ul",className:"task-list-item"},(0,i.kt)("input",{parentName:"li",type:"checkbox",checked:!1,disabled:!0})," ","SSL connection:")),(0,i.kt)("p",null,"Use either ",(0,i.kt)("inlineCode",{parentName:"p"},"rabbitmq_secure = 1")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"amqps")," in connection address: ",(0,i.kt)("inlineCode",{parentName:"p"},"rabbitmq_address = 'amqps://guest:guest@localhost/vhost'"),".\nThe default behaviour of the used library is not to check if the created TLS connection is sufficiently secure. Whether the certificate is expired, self-signed, missing or invalid: the connection is simply permitted. More strict checking of certificates can possibly be implemented in the future."),(0,i.kt)("p",null,"Also format settings can be added along with rabbitmq-related settings."),(0,i.kt)("p",null,"Example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"  CREATE TABLE queue (\n    key UInt64,\n    value UInt64,\n    date DateTime\n  ) ENGINE = RabbitMQ SETTINGS rabbitmq_host_port = 'localhost:5672',\n                            rabbitmq_exchange_name = 'exchange1',\n                            rabbitmq_format = 'JSONEachRow',\n                            rabbitmq_num_consumers = 5,\n                            date_time_input_format = 'best_effort';\n")),(0,i.kt)("p",null,"The RabbitMQ server configuration should be added using the ClickHouse config file."),(0,i.kt)("p",null,"Required configuration:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-xml"}," <rabbitmq>\n    <username>root</username>\n    <password>clickhouse</password>\n </rabbitmq>\n")),(0,i.kt)("p",null,"Additional configuration:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-xml"}," <rabbitmq>\n    <vhost>clickhouse</vhost>\n </rabbitmq>\n")),(0,i.kt)("h2",{id:"description"},"Description"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"SELECT")," is not particularly useful for reading messages (except for debugging), because each message can be read only once. It is more practical to create real-time threads using ",(0,i.kt)("a",{parentName:"p",href:"/AlgoliaDocsSelfCrawl/en/sql-reference/statements/create/view"},"materialized views"),". To do this:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Use the engine to create a RabbitMQ consumer and consider it a data stream."),(0,i.kt)("li",{parentName:"ol"},"Create a table with the desired structure."),(0,i.kt)("li",{parentName:"ol"},"Create a materialized view that converts data from the engine and puts it into a previously created table.")),(0,i.kt)("p",null,"When the ",(0,i.kt)("inlineCode",{parentName:"p"},"MATERIALIZED VIEW")," joins the engine, it starts collecting data in the background. This allows you to continually receive messages from RabbitMQ and convert them to the required format using ",(0,i.kt)("inlineCode",{parentName:"p"},"SELECT"),".\nOne RabbitMQ table can have as many materialized views as you like."),(0,i.kt)("p",null,"Data can be channeled based on ",(0,i.kt)("inlineCode",{parentName:"p"},"rabbitmq_exchange_type")," and the specified ",(0,i.kt)("inlineCode",{parentName:"p"},"rabbitmq_routing_key_list"),".\nThere can be no more than one exchange per table. One exchange can be shared between multiple tables - it enables routing into multiple tables at the same time."),(0,i.kt)("p",null,"Exchange type options:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"direct")," - Routing is based on the exact matching of keys. Example table key list: ",(0,i.kt)("inlineCode",{parentName:"li"},"key1,key2,key3,key4,key5"),", message key can equal any of them."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"fanout")," - Routing to all tables (where exchange name is the same) regardless of the keys."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"topic")," - Routing is based on patterns with dot-separated keys. Examples: ",(0,i.kt)("inlineCode",{parentName:"li"},"*.logs"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"records.*.*.2020"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"*.2018,*.2019,*.2020"),"."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"headers")," - Routing is based on ",(0,i.kt)("inlineCode",{parentName:"li"},"key=value")," matches with a setting ",(0,i.kt)("inlineCode",{parentName:"li"},"x-match=all")," or ",(0,i.kt)("inlineCode",{parentName:"li"},"x-match=any"),". Example table key list: ",(0,i.kt)("inlineCode",{parentName:"li"},"x-match=all,format=logs,type=report,year=2020"),"."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"consistent_hash")," - Data is evenly distributed between all bound tables (where the exchange name is the same). Note that this exchange type must be enabled with RabbitMQ plugin: ",(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq-plugins enable rabbitmq_consistent_hash_exchange"),".")),(0,i.kt)("p",null,"Setting ",(0,i.kt)("inlineCode",{parentName:"p"},"rabbitmq_queue_base")," may be used for the following cases:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"to let different tables share queues, so that multiple consumers could be registered for the same queues, which makes a better performance. If using ",(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_num_consumers")," and/or ",(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_num_queues")," settings, the exact match of queues is achieved in case these parameters are the same."),(0,i.kt)("li",{parentName:"ul"},"to be able to restore reading from certain durable queues when not all messages were successfully consumed. To resume consumption from one specific queue - set its name in ",(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_queue_base")," setting and do not specify ",(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_num_consumers")," and ",(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_num_queues")," (defaults to 1). To resume consumption from all queues, which were declared for a specific table - just specify the same settings: ",(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_queue_base"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_num_consumers"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_num_queues"),". By default, queue names will be unique to tables."),(0,i.kt)("li",{parentName:"ul"},"to reuse queues as they are declared durable and not auto-deleted. (Can be deleted via any of RabbitMQ CLI tools.)")),(0,i.kt)("p",null,"To improve performance, received messages are grouped into blocks the size of ",(0,i.kt)("a",{parentName:"p",href:"/AlgoliaDocsSelfCrawl/en/operations/server-configuration-parameters/settings#settings-max_insert_block_size"},"max_insert_block_size"),". If the block wasn\u2019t formed within ",(0,i.kt)("a",{parentName:"p",href:"/AlgoliaDocsSelfCrawl/en/operations/server-configuration-parameters/settings"},"stream_flush_interval_ms")," milliseconds, the data will be flushed to the table regardless of the completeness of the block."),(0,i.kt)("p",null,"If ",(0,i.kt)("inlineCode",{parentName:"p"},"rabbitmq_num_consumers")," and/or ",(0,i.kt)("inlineCode",{parentName:"p"},"rabbitmq_num_queues")," settings are specified along with ",(0,i.kt)("inlineCode",{parentName:"p"},"rabbitmq_exchange_type"),", then:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq-consistent-hash-exchange")," plugin must be enabled."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"message_id")," property of the published messages must be specified (unique for each message/batch).")),(0,i.kt)("p",null,"For insert query there is message metadata, which is added for each published message: ",(0,i.kt)("inlineCode",{parentName:"p"},"messageID")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"republished")," flag (true, if published more than once) - can be accessed via message headers."),(0,i.kt)("p",null,"Do not use the same table for inserts and materialized views."),(0,i.kt)("p",null,"Example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"  CREATE TABLE queue (\n    key UInt64,\n    value UInt64\n  ) ENGINE = RabbitMQ SETTINGS rabbitmq_host_port = 'localhost:5672',\n                            rabbitmq_exchange_name = 'exchange1',\n                            rabbitmq_exchange_type = 'headers',\n                            rabbitmq_routing_key_list = 'format=logs,type=report,year=2020',\n                            rabbitmq_format = 'JSONEachRow',\n                            rabbitmq_num_consumers = 5;\n\n  CREATE TABLE daily (key UInt64, value UInt64)\n    ENGINE = MergeTree() ORDER BY key;\n\n  CREATE MATERIALIZED VIEW consumer TO daily\n    AS SELECT key, value FROM queue;\n\n  SELECT key, value FROM daily ORDER BY key;\n")),(0,i.kt)("h2",{id:"virtual-columns"},"Virtual Columns"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"_exchange_name")," - RabbitMQ exchange name."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"_channel_id")," - ChannelID, on which consumer, who received the message, was declared."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"_delivery_tag")," - DeliveryTag of the received message. Scoped per channel."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"_redelivered")," - ",(0,i.kt)("inlineCode",{parentName:"li"},"redelivered")," flag of the message."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"_message_id")," - messageID of the received message; non-empty if was set, when message was published."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"_timestamp")," - timestamp of the received message; non-empty if was set, when message was published.")),(0,i.kt)("h2",{id:"data-formats-support"},"Data formats support"),(0,i.kt)("p",null,"RabbitMQ engine supports all ",(0,i.kt)("a",{parentName:"p",href:"/AlgoliaDocsSelfCrawl/en/interfaces/formats"},"formats")," supported in ClickHouse.\nThe number of rows in one RabbitMQ message depends on whether the format is row-based or block-based:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"For row-based formats the number of rows in one RabbitMQ message can be controlled by setting ",(0,i.kt)("inlineCode",{parentName:"li"},"rabbitmq_max_rows_per_message"),"."),(0,i.kt)("li",{parentName:"ul"},"For block-based formats we cannot divide block into smaller parts, but the number of rows in one block can be controlled by general setting ",(0,i.kt)("a",{parentName:"li",href:"/AlgoliaDocsSelfCrawl/en/operations/settings/settings#setting-max_block_size"},"max_block_size"),".")))}p.isMDXComponent=!0}}]);