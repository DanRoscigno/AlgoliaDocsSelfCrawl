"use strict";(self.webpackChunkclickhouse_docs_2_3_0=self.webpackChunkclickhouse_docs_2_3_0||[]).push([[3341],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>g});var r=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n,r,i={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=r.createContext({}),u=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},c=function(e){var t=u(e.components);return r.createElement(l.Provider,{value:t},e.children)},p="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,i=e.mdxType,a=e.originalType,l=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),p=u(n),d=i,g=p["".concat(l,".").concat(d)]||p[d]||m[d]||a;return n?r.createElement(g,s(s({ref:t},c),{},{components:n})):r.createElement(g,s({ref:t},c))}));function g(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var a=n.length,s=new Array(a);s[0]=d;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o[p]="string"==typeof e?e:i,s[1]=o;for(var u=2;u<a;u++)s[u]=n[u];return r.createElement.apply(null,s)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},70244:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>m,frontMatter:()=>a,metadata:()=>o,toc:()=>u});var r=n(87462),i=(n(67294),n(3905));const a={slug:"/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-intro",sidebar_label:"Introduction",sidebar_position:1,description:"TODO"},s="A Practical Introduction to Primary Indexes in ClickHouse",o={unversionedId:"en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-intro",id:"en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-intro",title:"A Practical Introduction to Primary Indexes in ClickHouse",description:"TODO",source:"@site/docs/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-intro.md",sourceDirName:"en/guides/improving-query-performance/sparse-primary-indexes",slug:"/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-intro",permalink:"/AlgoliaDocsSelfCrawl/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-intro",draft:!1,editUrl:"https://github.com/ClickHouse/clickhouse-docs/blob/main/docs/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-intro.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{slug:"/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-intro",sidebar_label:"Introduction",sidebar_position:1,description:"TODO"}},l={},u=[{value:"Data Set",id:"data-set",level:2},{value:"Test Machine",id:"test-machine",level:2},{value:"A full table scan",id:"a-full-table-scan",level:2},{value:"Related content",id:"related-content",level:2}],c={toc:u},p="wrapper";function m(e){let{components:t,...n}=e;return(0,i.kt)(p,(0,r.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"a-practical-introduction-to-primary-indexes-in-clickhouse"},"A Practical Introduction to Primary Indexes in ClickHouse"),(0,i.kt)("p",null,"In this guide we are going to do a deep dive into ClickHouse indexing. We will illustrate and discuss in detail:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"/AlgoliaDocsSelfCrawl/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-design/#an-index-design-for-massive-data-scales"},"how indexing in ClickHouse is different from traditional relational database management systems")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"/AlgoliaDocsSelfCrawl/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-design/#a-table-with-a-primary-key"},"how ClickHouse is building and using a table\u2019s sparse primary index")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"/AlgoliaDocsSelfCrawl/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-multiple"},"what some of the best practices are for indexing in ClickHouse"))),(0,i.kt)("p",null,"You can optionally execute all ClickHouse SQL statements and queries given in this guide by yourself on your own machine.\nFor installation of ClickHouse and getting started instructions, see the ",(0,i.kt)("a",{parentName:"p",href:"/AlgoliaDocsSelfCrawl/en/getting-started/quick-start"},"Quick Start"),"."),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"This guide is focusing on ClickHouse sparse primary indexes."),(0,i.kt)("p",{parentName:"admonition"},"For ClickHouse ",(0,i.kt)("a",{parentName:"p",href:"/docs/en/engines/table-engines/mergetree-family/mergetree.md/#table_engine-mergetree-data_skipping-indexes"},"secondary data skipping indexes"),", see the ",(0,i.kt)("a",{parentName:"p",href:"/AlgoliaDocsSelfCrawl/en/guides/improving-query-performance/skipping-indexes"},"Tutorial"),".")),(0,i.kt)("h2",{id:"data-set"},"Data Set"),(0,i.kt)("p",null,"Throughout this guide we will use a sample anonymized web traffic data set."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"We will use a subset of 8.87 million rows (events) from the sample data set."),(0,i.kt)("li",{parentName:"ul"},"The uncompressed data size is 8.87 million events and about 700 MB. This compresses to 200 mb when stored in ClickHouse."),(0,i.kt)("li",{parentName:"ul"},"In our subset, each row contains three columns that indicate an internet user (",(0,i.kt)("inlineCode",{parentName:"li"},"UserID")," column) who clicked on a URL (",(0,i.kt)("inlineCode",{parentName:"li"},"URL")," column) at a specific time (",(0,i.kt)("inlineCode",{parentName:"li"},"EventTime")," column).")),(0,i.kt)("p",null,"With these three columns we can already formulate some typical web analytics queries such as:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},'"What are the top 10 most clicked urls for a specific user?\u201d'),(0,i.kt)("li",{parentName:"ul"},'"What are the top 10 users that most frequently clicked a specific URL?"'),(0,i.kt)("li",{parentName:"ul"},"\u201cWhat are the most popular times (e.g. days of the week) at which a user clicks on a specific URL?\u201d")),(0,i.kt)("h2",{id:"test-machine"},"Test Machine"),(0,i.kt)("p",null,"All runtime numbers given in this document are based on running ClickHouse 22.2.1 locally on a MacBook Pro with the Apple M1 Pro chip and 16GB of RAM."),(0,i.kt)("h2",{id:"a-full-table-scan"},"A full table scan"),(0,i.kt)("p",null,"In order to see how a query is executed over our data set without a primary key, we create a table (with a MergeTree table engine) by executing the following SQL DDL statement:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE TABLE hits_NoPrimaryKey\n(\n    `UserID` UInt32,\n    `URL` String,\n    `EventTime` DateTime\n)\nENGINE = MergeTree\nPRIMARY KEY tuple();\n")),(0,i.kt)("p",null,"Next insert a subset of the hits data set into the table with the following SQL insert statement.\nThis uses the ",(0,i.kt)("a",{parentName:"p",href:"/docs/en/sql-reference/table-functions/url.md"},"URL table function")," in order to load a  subset of the full dataset hosted remotely at clickhouse.com:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"INSERT INTO hits_NoPrimaryKey SELECT\n   intHash32(UserID) AS UserID,\n   URL,\n   EventTime\nFROM url('https://datasets.clickhouse.com/hits/tsv/hits_v1.tsv.xz', 'TSV', 'WatchID UInt64,  JavaEnable UInt8,  Title String,  GoodEvent Int16,  EventTime DateTime,  EventDate Date,  CounterID UInt32,  ClientIP UInt32,  ClientIP6 FixedString(16),  RegionID UInt32,  UserID UInt64,  CounterClass Int8,  OS UInt8,  UserAgent UInt8,  URL String,  Referer String,  URLDomain String,  RefererDomain String,  Refresh UInt8,  IsRobot UInt8,  RefererCategories Array(UInt16),  URLCategories Array(UInt16), URLRegions Array(UInt32),  RefererRegions Array(UInt32),  ResolutionWidth UInt16,  ResolutionHeight UInt16,  ResolutionDepth UInt8,  FlashMajor UInt8, FlashMinor UInt8,  FlashMinor2 String,  NetMajor UInt8,  NetMinor UInt8, UserAgentMajor UInt16,  UserAgentMinor FixedString(2),  CookieEnable UInt8, JavascriptEnable UInt8,  IsMobile UInt8,  MobilePhone UInt8,  MobilePhoneModel String,  Params String,  IPNetworkID UInt32,  TraficSourceID Int8, SearchEngineID UInt16,  SearchPhrase String,  AdvEngineID UInt8,  IsArtifical UInt8,  WindowClientWidth UInt16,  WindowClientHeight UInt16,  ClientTimeZone Int16,  ClientEventTime DateTime,  SilverlightVersion1 UInt8, SilverlightVersion2 UInt8,  SilverlightVersion3 UInt32,  SilverlightVersion4 UInt16,  PageCharset String,  CodeVersion UInt32,  IsLink UInt8,  IsDownload UInt8,  IsNotBounce UInt8,  FUniqID UInt64,  HID UInt32,  IsOldCounter UInt8, IsEvent UInt8,  IsParameter UInt8,  DontCountHits UInt8,  WithHash UInt8, HitColor FixedString(1),  UTCEventTime DateTime,  Age UInt8,  Sex UInt8,  Income UInt8,  Interests UInt16,  Robotness UInt8,  GeneralInterests Array(UInt16), RemoteIP UInt32,  RemoteIP6 FixedString(16),  WindowName Int32,  OpenerName Int32,  HistoryLength Int16,  BrowserLanguage FixedString(2),  BrowserCountry FixedString(2),  SocialNetwork String,  SocialAction String,  HTTPError UInt16, SendTiming Int32,  DNSTiming Int32,  ConnectTiming Int32,  ResponseStartTiming Int32,  ResponseEndTiming Int32,  FetchTiming Int32,  RedirectTiming Int32, DOMInteractiveTiming Int32,  DOMContentLoadedTiming Int32,  DOMCompleteTiming Int32,  LoadEventStartTiming Int32,  LoadEventEndTiming Int32, NSToDOMContentLoadedTiming Int32,  FirstPaintTiming Int32,  RedirectCount Int8, SocialSourceNetworkID UInt8,  SocialSourcePage String,  ParamPrice Int64, ParamOrderID String,  ParamCurrency FixedString(3),  ParamCurrencyID UInt16, GoalsReached Array(UInt32),  OpenstatServiceName String,  OpenstatCampaignID String,  OpenstatAdID String,  OpenstatSourceID String,  UTMSource String, UTMMedium String,  UTMCampaign String,  UTMContent String,  UTMTerm String, FromTag String,  HasGCLID UInt8,  RefererHash UInt64,  URLHash UInt64,  CLID UInt32,  YCLID UInt64,  ShareService String,  ShareURL String,  ShareTitle String,  ParsedParams Nested(Key1 String,  Key2 String, Key3 String, Key4 String, Key5 String,  ValueDouble Float64),  IslandID FixedString(16),  RequestNum UInt32,  RequestTry UInt8')\nWHERE URL != '';\n")),(0,i.kt)("p",null,"The response is:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-response"},"Ok.\n\n0 rows in set. Elapsed: 145.993 sec. Processed 8.87 million rows, 18.40 GB (60.78 thousand rows/s., 126.06 MB/s.)\n")),(0,i.kt)("p",null,"ClickHouse client\u2019s result output shows us that the statement above inserted 8.87 million rows into the table."),(0,i.kt)("p",null,"Lastly, in order to simplify the discussions later on in this guide and to make the diagrams and results reproducible, we ",(0,i.kt)("a",{parentName:"p",href:"/docs/en/sql-reference/statements/optimize.md"},"optimize")," the table using the FINAL keyword:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"OPTIMIZE TABLE hits_NoPrimaryKey FINAL;\n")),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"In general it is not required nor recommended to immediately optimize a table\nafter loading data into it. Why this is necessary for this example will become apparent.")),(0,i.kt)("p",null,"Now we execute our first web analytics query. The following is calculating the top 10 most clicked urls for the internet user with the UserID 749927693:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT URL, count(URL) as Count\nFROM hits_NoPrimaryKey\nWHERE UserID = 749927693\nGROUP BY URL\nORDER BY Count DESC\nLIMIT 10;\n")),(0,i.kt)("p",null,"The response is:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-response"},"\u250c\u2500URL\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500Count\u2500\u2510\n\u2502 http://auto.ru/chatay-barana.. \u2502   170 \u2502\n\u2502 http://auto.ru/chatay-id=371...\u2502    52 \u2502\n\u2502 http://public_search           \u2502    45 \u2502\n\u2502 http://kovrik-medvedevushku-...\u2502    36 \u2502\n\u2502 http://forumal                 \u2502    33 \u2502\n\u2502 http://korablitz.ru/L_1OFFER...\u2502    14 \u2502\n\u2502 http://auto.ru/chatay-id=371...\u2502    14 \u2502\n\u2502 http://auto.ru/chatay-john-D...\u2502    13 \u2502\n\u2502 http://auto.ru/chatay-john-D...\u2502    10 \u2502\n\u2502 http://wot/html?page/23600_m...\u2502     9 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n10 rows in set. Elapsed: 0.022 sec.\n// highlight-next-line\nProcessed 8.87 million rows,\n70.45 MB (398.53 million rows/s., 3.17 GB/s.)\n")),(0,i.kt)("p",null,"ClickHouse client\u2019s result output indicates that ClickHouse executed a full table scan! Each single row of the 8.87 million rows of our table was streamed into ClickHouse. That doesn\u2019t scale."),(0,i.kt)("p",null,"To make this (way) more efficient and (much) faster, we need to use a table with a appropriate primary key. This will allow ClickHouse to automatically (based on the primary key\u2019s column(s)) create a sparse primary index which can then be used to significantly speed up the execution of our example query."),(0,i.kt)("h2",{id:"related-content"},"Related content"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Blog: ",(0,i.kt)("a",{parentName:"li",href:"https://clickhouse.com/blog/clickhouse-faster-queries-with-projections-and-primary-indexes"},"Super charging your ClickHouse queries"))))}m.isMDXComponent=!0}}]);