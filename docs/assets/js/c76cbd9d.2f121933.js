"use strict";(self.webpackChunkclickhouse_docs_2_3_0=self.webpackChunkclickhouse_docs_2_3_0||[]).push([[30345],{3905:(e,t,a)=>{a.d(t,{Zo:()=>u,kt:()=>h});var o=a(67294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,o)}return a}function s(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,o,n=function(e,t){if(null==e)return{};var a,o,n={},r=Object.keys(e);for(o=0;o<r.length;o++)a=r[o],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)a=r[o],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var l=o.createContext({}),c=function(e){var t=o.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):s(s({},t),e)),a},u=function(e){var t=c(e.components);return o.createElement(l.Provider,{value:t},e.children)},d="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},p=o.forwardRef((function(e,t){var a=e.components,n=e.mdxType,r=e.originalType,l=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),d=c(a),p=n,h=d["".concat(l,".").concat(p)]||d[p]||m[p]||r;return a?o.createElement(h,s(s({ref:t},u),{},{components:a})):o.createElement(h,s({ref:t},u))}));function h(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var r=a.length,s=new Array(r);s[0]=p;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i[d]="string"==typeof e?e:n,s[1]=i;for(var c=2;c<r;c++)s[c]=a[c];return o.createElement.apply(null,s)}return o.createElement.apply(null,a)}p.displayName="MDXCreateElement"},34775:(e,t,a)=>{a.d(t,{ZP:()=>i});var o=a(87462),n=(a(67294),a(3905));const r={toc:[]},s="wrapper";function i(e){let{components:t,...i}=e;return(0,n.kt)(s,(0,o.Z)({},r,i,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("details",null,(0,n.kt)("summary",null,"Manage your IP Access List"),(0,n.kt)("p",null,"From your ClickHouse Cloud services list choose the service that you will work with and switch to ",(0,n.kt)("strong",{parentName:"p"},"Security"),".  If the IP Access List does not contain the IP Address or range of the remote system that needs to connect to your ClickHouse Cloud service, then you can resolve the problem with ",(0,n.kt)("strong",{parentName:"p"},"Add entry"),":"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"Check to see if the service allows traffic",src:a(78889).Z,width:"999",height:"519"})),(0,n.kt)("p",null,"Add the individual IP Address, or the range of addresses that need to connect to your ClickHouse Cloud service. Modify the form as you see fit and then ",(0,n.kt)("strong",{parentName:"p"},"Add entry")," and ",(0,n.kt)("strong",{parentName:"p"},"Submit entry"),"."),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"Add your current IP address",src:a(39671).Z,width:"595",height:"523"}))))}i.isMDXComponent=!0},87514:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>p,frontMatter:()=>s,metadata:()=>l,toc:()=>u});var o=a(87462),n=(a(67294),a(3905)),r=a(34775);const s={sidebar_position:10,sidebar_label:"ClickHouse to ClickHouse Cloud",slug:"/en/integrations/migration/clickhouse-to-cloud"},i="Migrating between self-managed ClickHouse and ClickHouse Cloud",l={unversionedId:"en/integrations/migration/clickhouse-to-cloud",id:"en/integrations/migration/clickhouse-to-cloud",title:"Migrating between self-managed ClickHouse and ClickHouse Cloud",description:"This guide will show how to migrate from a self-managed ClickHouse server to ClickHouse Cloud, and also how to migrate between ClickHouse Cloud services. The remoteSecure function is used in SELECT and INSERT queries to allow access to remote ClickHouse servers, which makes migrating tables as simple as writing an INSERT INTO query with an embedded SELECT.",source:"@site/docs/en/integrations/migration/clickhouse-to-cloud.md",sourceDirName:"en/integrations/migration",slug:"/en/integrations/migration/clickhouse-to-cloud",permalink:"/docs/en/integrations/migration/clickhouse-to-cloud",draft:!1,editUrl:"https://github.com/ClickHouse/clickhouse-docs/blob/main/docs/en/integrations/migration/clickhouse-to-cloud.md",tags:[],version:"current",sidebarPosition:10,frontMatter:{sidebar_position:10,sidebar_label:"ClickHouse to ClickHouse Cloud",slug:"/en/integrations/migration/clickhouse-to-cloud"},sidebar:"english",previous:{title:"Overview",permalink:"/docs/en/integrations/migration/"},next:{title:"Using clickhouse-local",permalink:"/docs/en/integrations/migration/clickhouse-local"}},c={},u=[{value:"Migrating from Self-managed ClickHouse to ClickHouse Cloud",id:"migrating-from-self-managed-clickhouse-to-clickhouse-cloud",level:2},{value:"Overview",id:"overview",level:3},{value:"Migration of tables from one system to another:",id:"migration-of-tables-from-one-system-to-another",level:3},{value:"On the source ClickHouse system (the system that currently hosts the data)",id:"on-the-source-clickhouse-system-the-system-that-currently-hosts-the-data",level:3},{value:"On the destination ClickHouse Cloud system:",id:"on-the-destination-clickhouse-cloud-system",level:3},{value:"Migrating between ClickHouse Cloud services",id:"migrating-between-clickhouse-cloud-services",level:2},{value:"Add a read-only user to the source service",id:"add-a-read-only-user-to-the-source-service",level:4},{value:"Duplicate the table structure on the destination service",id:"duplicate-the-table-structure-on-the-destination-service",level:4},{value:"Allow remote access to the source service",id:"allow-remote-access-to-the-source-service",level:4},{value:"Copy the data from source to destination",id:"copy-the-data-from-source-to-destination",level:4},{value:"Re-establish the IP Access List on the source",id:"re-establish-the-ip-access-list-on-the-source",level:4},{value:"Remove the read-only <code>exporter</code> user",id:"remove-the-read-only-exporter-user",level:4}],d={toc:u},m="wrapper";function p(e){let{components:t,...s}=e;return(0,n.kt)(m,(0,o.Z)({},d,s,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h1",{id:"migrating-between-self-managed-clickhouse-and-clickhouse-cloud"},"Migrating between self-managed ClickHouse and ClickHouse Cloud"),(0,n.kt)("img",{src:a(99969).Z,class:"image",alt:"Migrating Self-managed ClickHouse",style:{width:"80%",padding:"30px"}}),(0,n.kt)("p",null,"This guide will show how to migrate from a self-managed ClickHouse server to ClickHouse Cloud, and also how to migrate between ClickHouse Cloud services. The ",(0,n.kt)("a",{parentName:"p",href:"/docs/en/sql-reference/table-functions/remote"},(0,n.kt)("inlineCode",{parentName:"a"},"remoteSecure"))," function is used in ",(0,n.kt)("inlineCode",{parentName:"p"},"SELECT")," and ",(0,n.kt)("inlineCode",{parentName:"p"},"INSERT")," queries to allow access to remote ClickHouse servers, which makes migrating tables as simple as writing an ",(0,n.kt)("inlineCode",{parentName:"p"},"INSERT INTO")," query with an embedded ",(0,n.kt)("inlineCode",{parentName:"p"},"SELECT"),"."),(0,n.kt)("h2",{id:"migrating-from-self-managed-clickhouse-to-clickhouse-cloud"},"Migrating from Self-managed ClickHouse to ClickHouse Cloud"),(0,n.kt)("img",{src:a(59353).Z,class:"image",alt:"Migrating Self-managed ClickHouse",style:{width:"30%",padding:"30px"}}),(0,n.kt)("admonition",{type:"note"},(0,n.kt)("p",{parentName:"admonition"},"Regardless of if your source table is sharded and/or replicated, on ClickHouse Cloud you just create a destination table (you can leave out the Engine parameter for this table, it will be automatically a ReplicatedMergeTree table),\nand ClickHouse Cloud will automatically take care of vertical and horizontal scaling. There is no need from your side to think about how to replicate and shard the table.")),(0,n.kt)("p",null,"In this example the self-managed ClickHouse server is the ",(0,n.kt)("em",{parentName:"p"},"source")," and the ClickHouse Cloud service is the ",(0,n.kt)("em",{parentName:"p"},"destination"),"."),(0,n.kt)("h3",{id:"overview"},"Overview"),(0,n.kt)("p",null,"The process is:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Add a read-only user to the source service"),(0,n.kt)("li",{parentName:"ol"},"Duplicate the source table structure on the destination service"),(0,n.kt)("li",{parentName:"ol"},"Pull the data from source to destination, or push the data from the source, depending on the network availability of the source"),(0,n.kt)("li",{parentName:"ol"},"Remove the source server from the IP Access List on the destination (if applicable)"),(0,n.kt)("li",{parentName:"ol"},"Remove the read-only user from the source service")),(0,n.kt)("h3",{id:"migration-of-tables-from-one-system-to-another"},"Migration of tables from one system to another:"),(0,n.kt)("p",null,"This example migrates one table from a self-managed ClickHouse server to ClickHouse Cloud."),(0,n.kt)("h3",{id:"on-the-source-clickhouse-system-the-system-that-currently-hosts-the-data"},"On the source ClickHouse system (the system that currently hosts the data)"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Add a read only user that can read the source table (",(0,n.kt)("inlineCode",{parentName:"li"},"db.table")," in this example)")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE USER exporter\nIDENTIFIED WITH SHA256_PASSWORD BY 'password-here'\nSETTINGS readonly = 1;\n")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-sql"},"GRANT SELECT ON db.table TO exporter;\n")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Copy the table definition")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-sql"},"select create_table_query\nfrom system.tables\nwhere database = 'db' and table = 'table'\n")),(0,n.kt)("h3",{id:"on-the-destination-clickhouse-cloud-system"},"On the destination ClickHouse Cloud system:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Create the destination database:")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE DATABASE db\n")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Using the CREATE TABLE statement from the source, create the destination.")),(0,n.kt)("admonition",{type:"tip"},(0,n.kt)("p",{parentName:"admonition"},"Change the ENGINE to to ReplicatedMergeTree without any parameters when you run the CREATE statement. ClickHouse Cloud always replicates tables and provides the correct parameters. Keep the ",(0,n.kt)("inlineCode",{parentName:"p"},"ORDER BY"),", ",(0,n.kt)("inlineCode",{parentName:"p"},"PRIMARY KEY"),", ",(0,n.kt)("inlineCode",{parentName:"p"},"PARTITION BY"),", ",(0,n.kt)("inlineCode",{parentName:"p"},"SAMPLE BY"),", ",(0,n.kt)("inlineCode",{parentName:"p"},"TTL"),", and ",(0,n.kt)("inlineCode",{parentName:"p"},"SETTINGS")," clauses though.")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE TABLE db.table ...\n")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Use the ",(0,n.kt)("inlineCode",{parentName:"li"},"remoteSecure")," function to pull the data from the self-managed source")),(0,n.kt)("img",{src:a(34287).Z,class:"image",alt:"Migrating Self-managed ClickHouse",style:{width:"30%",padding:"30px"}}),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-sql"},"INSERT INTO db.table SELECT * FROM\nremoteSecure('source-hostname', db, table, 'exporter', 'password-here')\n")),(0,n.kt)("admonition",{type:"note"},(0,n.kt)("p",{parentName:"admonition"},"If the source system is not available from outside networks then you can push the data rather than pulling it, as the ",(0,n.kt)("inlineCode",{parentName:"p"},"remoteSecure")," function works for both selects and inserts.  See the next option.")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Use the ",(0,n.kt)("inlineCode",{parentName:"li"},"remoteSecure")," function to push the data to the ClickHouse Cloud service")),(0,n.kt)("img",{src:a(23157).Z,class:"image",alt:"Migrating Self-managed ClickHouse",style:{width:"30%",padding:"30px"}}),(0,n.kt)("admonition",{title:"Add the remote system to your ClickHouse Cloud service IP Access List",type:"tip"},(0,n.kt)("p",{parentName:"admonition"},"In order for the ",(0,n.kt)("inlineCode",{parentName:"p"},"remoteSecure")," function to connect to your ClickHouse Cloud service the IP Address of the remote system will need to be allowed by the IP Access List.  Expand ",(0,n.kt)("strong",{parentName:"p"},"Manage your IP Access List")," below this tip for more information.")),(0,n.kt)(r.ZP,{mdxType:"AddARemoteSystem"}),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-sql"},"INSERT INTO FUNCTION\nremoteSecure('HOSTNAME.clickhouse.cloud:9440', 'db.table',\n'default', 'PASS') SELECT * FROM db.table\n")),(0,n.kt)("h2",{id:"migrating-between-clickhouse-cloud-services"},"Migrating between ClickHouse Cloud services"),(0,n.kt)("img",{src:a(53595).Z,class:"image",alt:"Migrating Self-managed ClickHouse",style:{width:"80%",padding:"30px"}}),(0,n.kt)("p",null,"Some example uses for migrating data between ClickHouse Cloud services:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Migrating data from a restored backup"),(0,n.kt)("li",{parentName:"ul"},"Copying data from a development service to a staging service (or staging to production)")),(0,n.kt)("p",null,"In this example there are two ClickHouse Cloud services, and they will be referred to as ",(0,n.kt)("em",{parentName:"p"},"source")," and ",(0,n.kt)("em",{parentName:"p"},"destination"),".  The data will be pulled from the source to the destination. Although you could push if you like, pulling is shown as it uses a read-only user."),(0,n.kt)("img",{src:a(11482).Z,class:"image",alt:"Migrating Self-managed ClickHouse",style:{width:"80%",padding:"30px"}}),(0,n.kt)("p",null,"There are a few steps in the migration:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Identify one ClickHouse Cloud service to be the ",(0,n.kt)("em",{parentName:"li"},"source"),", and the other as the ",(0,n.kt)("em",{parentName:"li"},"destination")),(0,n.kt)("li",{parentName:"ol"},"Add a read-only user to the source service"),(0,n.kt)("li",{parentName:"ol"},"Duplicate the source table structure on the destination service"),(0,n.kt)("li",{parentName:"ol"},"Temporarily allow IP access to the source service"),(0,n.kt)("li",{parentName:"ol"},"Copy the data from source to destination"),(0,n.kt)("li",{parentName:"ol"},"Re-establish the IP Access List on the destination"),(0,n.kt)("li",{parentName:"ol"},"Remove the read-only user from the source service")),(0,n.kt)("h4",{id:"add-a-read-only-user-to-the-source-service"},"Add a read-only user to the source service"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},"Add a read only user that can read the source table (",(0,n.kt)("inlineCode",{parentName:"p"},"db.table")," in this example)"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE USER exporter\nIDENTIFIED WITH SHA256_PASSWORD BY 'password-here'\nSETTINGS readonly = 1;\n")),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-sql"},"GRANT SELECT ON db.table TO exporter;\n"))),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},"Copy the table definition"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-sql"},"select create_table_query\nfrom system.tables\nwhere database = 'db' and table = 'table'\n")))),(0,n.kt)("h4",{id:"duplicate-the-table-structure-on-the-destination-service"},"Duplicate the table structure on the destination service"),(0,n.kt)("p",null,"On the destination create the database if it is not there already:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Create the destination database:",(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE DATABASE db\n")))),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},"Using the CREATE TABLE statement from the source, create the destination."),(0,n.kt)("p",{parentName:"li"},"On the destination create the table using the output of the ",(0,n.kt)("inlineCode",{parentName:"p"},"select create_table_query...")," from the source:"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE TABLE db.table ...\n")))),(0,n.kt)("h4",{id:"allow-remote-access-to-the-source-service"},"Allow remote access to the source service"),(0,n.kt)("p",null,'In order to pull data from the source to the destination the source service must allow connections. Temporarily disable the "IP Access List" functionality on the source service.'),(0,n.kt)("admonition",{type:"tip"},(0,n.kt)("p",{parentName:"admonition"},"If you will continue to use the source ClickHouse Cloud service then export the existing IP Access list to a JSON file before switching to allow access from anywhere; this will allow you to import the access list after the data is migrated.")),(0,n.kt)("p",null,"Modify the allow list and allow access from ",(0,n.kt)("strong",{parentName:"p"},"Anywhere")," temporarily. See the ",(0,n.kt)("a",{parentName:"p",href:"/docs/en/manage/security/ip-access-list"},"IP Access List")," docs for details."),(0,n.kt)("h4",{id:"copy-the-data-from-source-to-destination"},"Copy the data from source to destination"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},"Use the ",(0,n.kt)("inlineCode",{parentName:"p"},"remoteSecure")," function to pull the data from the source ClickHouse Cloud service\nConnect to the destination.  Run this command on the destination ClickHouse Cloud service:"),(0,n.kt)("pre",{parentName:"li"},(0,n.kt)("code",{parentName:"pre",className:"language-sql"},"INSERT INTO db.table SELECT * FROM\nremoteSecure('source-hostname', db, table, 'exporter', 'password-here')\n"))),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},"Verify the data in the destination service"))),(0,n.kt)("h4",{id:"re-establish-the-ip-access-list-on-the-source"},"Re-establish the IP Access List on the source"),(0,n.kt)("p",null,"  If you exported the access list earlier, then you can re-import it using ",(0,n.kt)("strong",{parentName:"p"},"Share"),", otherwise re-add your entries to the access list."),(0,n.kt)("h4",{id:"remove-the-read-only-exporter-user"},"Remove the read-only ",(0,n.kt)("inlineCode",{parentName:"h4"},"exporter")," user"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-sql"},"DROP USER exporter\n")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Switch the service IP Access List to limit access")))}p.isMDXComponent=!0},99969:(e,t,a)=>{a.d(t,{Z:()=>o});const o=a.p+"assets/images/self-managed-01-9a998ad5f1dd97d42d3c4ba153b492f3.png"},59353:(e,t,a)=>{a.d(t,{Z:()=>o});const o=a.p+"assets/images/self-managed-02-20399b925e5eb4faa44779a3b5e018be.png"},34287:(e,t,a)=>{a.d(t,{Z:()=>o});const o=a.p+"assets/images/self-managed-03-4d9cfa6836774254aadb80110369f5e2.png"},23157:(e,t,a)=>{a.d(t,{Z:()=>o});const o=a.p+"assets/images/self-managed-04-3a64242b05af95c83973019c33c8ecd3.png"},53595:(e,t,a)=>{a.d(t,{Z:()=>o});const o=a.p+"assets/images/self-managed-05-6f74631cc8b3421cf84d24477f9f1459.png"},11482:(e,t,a)=>{a.d(t,{Z:()=>o});const o=a.p+"assets/images/self-managed-06-f80a14f6197a08fb0605488ae71c95cb.png"},39671:(e,t,a)=>{a.d(t,{Z:()=>o});const o=a.p+"assets/images/ip-allow-list-add-current-ip-308aa8c2edde4c6d29569c209968ddbc.png"},78889:(e,t,a)=>{a.d(t,{Z:()=>o});const o=a.p+"assets/images/ip-allow-list-check-list-a3ec1682582a2648eaa2c1727170f893.png"}}]);