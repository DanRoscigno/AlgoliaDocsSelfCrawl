"use strict";(self.webpackChunkclickhouse_docs_2_3_0=self.webpackChunkclickhouse_docs_2_3_0||[]).push([[51209],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>k});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},d="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),d=c(n),u=r,k=d["".concat(l,".").concat(u)]||d[u]||m[u]||o;return n?a.createElement(k,i(i({ref:t},p),{},{components:n})):a.createElement(k,i({ref:t},p))}));function k(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[d]="string"==typeof e?e:r,i[1]=s;for(var c=2;c<o;c++)i[c]=n[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},45928:(e,t,n)=>{n.d(t,{ZP:()=>s});var a=n(87462),r=(n(67294),n(3905));const o={toc:[]},i="wrapper";function s(e){let{components:t,...n}=e;return(0,r.kt)(i,(0,a.Z)({},o,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"This page is not applicable to ",(0,r.kt)("a",{parentName:"p",href:"https://clickhouse.com/cloud"},"ClickHouse Cloud"),". The procedure documented here is automated in ClickHouse Cloud services.")))}s.isMDXComponent=!0},76119:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>s,default:()=>u,frontMatter:()=>i,metadata:()=>l,toc:()=>p});var a=n(87462),r=(n(67294),n(3905)),o=n(45928);const i={slug:"/en/guides/sre/configuring-ssl",sidebar_label:"Configuring SSL-TLS",sidebar_position:20},s="Configuring SSL-TLS",l={unversionedId:"en/guides/sre/configuring-ssl",id:"en/guides/sre/configuring-ssl",title:"Configuring SSL-TLS",description:"This guide provides simple and minimal settings to configure ClickHouse to use OpenSSL certificates to validate connections. For this demonstration, a self-signed Certificate Authority (CA) certificate and key are created with node certificates to make the connections with appropriate settings.",source:"@site/docs/en/guides/sre/configuring-ssl.md",sourceDirName:"en/guides/sre",slug:"/en/guides/sre/configuring-ssl",permalink:"/docs/en/guides/sre/configuring-ssl",draft:!1,editUrl:"https://github.com/ClickHouse/clickhouse-docs/blob/main/docs/en/guides/sre/configuring-ssl.md",tags:[],version:"current",sidebarPosition:20,frontMatter:{slug:"/en/guides/sre/configuring-ssl",sidebar_label:"Configuring SSL-TLS",sidebar_position:20},sidebar:"english",previous:{title:"Rebalancing Shards",permalink:"/docs/en/guides/sre/scaling-clusters"},next:{title:"Users",permalink:"/docs/en/manage/users"}},c={},p=[{value:"1. Create a ClickHouse Deployment",id:"1-create-a-clickhouse-deployment",level:2},{value:"2. Create SSL certicates",id:"2-create-ssl-certicates",level:2},{value:"3. Create and Configure a directory to store certificates and keys.",id:"3-create-and-configure-a-directory-to-store-certificates-and-keys",level:2},{value:"4. Configure the environment with basic clusters using ClickHouse Keeper",id:"4-configure-the-environment-with-basic-clusters-using-clickhouse-keeper",level:2},{value:"5. Configure SSL-TLS interfaces on ClickHouse nodes",id:"5-configure-ssl-tls-interfaces-on-clickhouse-nodes",level:2},{value:"6. Testing",id:"6-testing",level:2},{value:"Summary",id:"summary",level:2}],d={toc:p},m="wrapper";function u(e){let{components:t,...i}=e;return(0,r.kt)(m,(0,a.Z)({},d,i,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"configuring-ssl-tls"},"Configuring SSL-TLS"),(0,r.kt)(o.ZP,{mdxType:"SelfManaged"}),(0,r.kt)("p",null,"This guide provides simple and minimal settings to configure ClickHouse to use OpenSSL certificates to validate connections. For this demonstration, a self-signed Certificate Authority (CA) certificate and key are created with node certificates to make the connections with appropriate settings."),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"TLS implementation is complex and there are many options to consider to ensure a fully secure and robust deployment. This is a basic tutorial with basic SSL/TLS configuration examples. Consult with your PKI/security team to generate the correct certificates for your organization."),(0,r.kt)("p",{parentName:"admonition"},"Review this ",(0,r.kt)("a",{parentName:"p",href:"https://ubuntu.com/server/docs/security-certificates"},"basic tutorial on certificate usage")," for an introductory overview.")),(0,r.kt)("h2",{id:"1-create-a-clickhouse-deployment"},"1. Create a ClickHouse Deployment"),(0,r.kt)("p",null,"This guide was written using Ubuntu 20.04 and ClickHouse installed on the following hosts using the DEB package (using apt). The domain is ",(0,r.kt)("inlineCode",{parentName:"p"},"marsnet.local"),":"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Host"),(0,r.kt)("th",{parentName:"tr",align:null},"IP Address"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"chnode1"),(0,r.kt)("td",{parentName:"tr",align:null},"192.168.1.221")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"chnode2"),(0,r.kt)("td",{parentName:"tr",align:null},"192.168.1.222")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"chnode3"),(0,r.kt)("td",{parentName:"tr",align:null},"192.168.1.223")))),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"View the ",(0,r.kt)("a",{parentName:"p",href:"/docs/en/install"},"Quick Start")," for more details on how to install ClickHouse.")),(0,r.kt)("h2",{id:"2-create-ssl-certicates"},"2. Create SSL certicates"),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"Using self-signed certificates are for demonstration purposes only and should not used in production. Certificate requests should be created to be signed by the organization and validated using the CA chain that will be configured in the settings. However, these steps can be used to configure and test settings, then can be replaced by the actual certificates that will be used.")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Generate a key that will be used for the new CA:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"openssl genrsa -out marsnet_ca.key 2048\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Generate a new self-signed CA certificate. The following will create a new certificate that will be used to sign other certificates using the CA key:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'openssl req -x509 -subj "/CN=marsnet.local CA" -nodes -key marsnet_ca.key -days 1095 -out marsnet_ca.crt\n')),(0,r.kt)("admonition",{parentName:"li",type:"note"},(0,r.kt)("p",{parentName:"admonition"},"Backup the key and CA certificate in a secure location not in the cluster. After generating the node certificates, the key should be deleted from the cluster nodes."))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Verify the contents of the new CA certificate:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"openssl x509 -in marsnet_ca.crt -text\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Create a certificate request (CSR) and generate a key for each node:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'openssl req -newkey rsa:2048 -nodes -subj "/CN=chnode1" -addext "subjectAltName = DNS:chnode1.marsnet.local,IP:192.168.1.221" -keyout chnode1.key -out chnode1.csr\nopenssl req -newkey rsa:2048 -nodes -subj "/CN=chnode2" -addext "subjectAltName = DNS:chnode2.marsnet.local,IP:192.168.1.222" -keyout chnode2.key -out chnode2.csr\nopenssl req -newkey rsa:2048 -nodes -subj "/CN=chnode3" -addext "subjectAltName = DNS:chnode3.marsnet.local,IP:192.168.1.223" -keyout chnode3.key -out chnode3.csr\n'))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Using the CSR and CA, create new certificate and key pairs:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"openssl x509 -req -in chnode1.csr -out chnode1.crt -CAcreateserial -CA marsnet_ca.crt -CAkey marsnet_ca.key -days 365\nopenssl x509 -req -in chnode2.csr -out chnode2.crt -CAcreateserial -CA marsnet_ca.crt -CAkey marsnet_ca.key -days 365\nopenssl x509 -req -in chnode3.csr -out chnode3.crt -CAcreateserial -CA marsnet_ca.crt -CAkey marsnet_ca.key -days 365\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Verify the certs for subject and issuer:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"openssl x509 -in chnode1.crt -text -noout\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Check that the new certificates verify against the CA cert:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"openssl verify -CAfile marsnet_ca.crt chnode1.crt\nchnode1.crt: OK\n")))),(0,r.kt)("h2",{id:"3-create-and-configure-a-directory-to-store-certificates-and-keys"},"3. Create and Configure a directory to store certificates and keys."),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"This must be done on each node. Use appropriate certificates and keys on each host.")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Create a folder in a directory accessible by ClickHouse in each node. We recommend the default configuration directory (e.g. ",(0,r.kt)("inlineCode",{parentName:"p"},"/etc/clickhouse-server"),"):"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir /etc/clickhouse-server/certs\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Copy the CA certificate, node certificate and key corresponding to each node to the new certs directory.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Update owner and permissions to allow ClickHouse to read the certificates:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"chown clickhouse:clickhouse -R /etc/clickhouse-server/certs\nchmod 600 /etc/clickhouse-server/certs/*\nchmod 755 /etc/clickhouse-server/certs\nll /etc/clickhouse-server/certs\n")),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-response"},"total 20\ndrw-r--r-- 2 clickhouse clickhouse 4096 Apr 12 20:23 ./\ndrwx------ 5 clickhouse clickhouse 4096 Apr 12 20:23 ../\n-rw------- 1 clickhouse clickhouse  997 Apr 12 20:22 chnode1.crt\n-rw------- 1 clickhouse clickhouse 1708 Apr 12 20:22 chnode1.key\n-rw------- 1 clickhouse clickhouse 1131 Apr 12 20:23 marsnet_ca.crt\n")))),(0,r.kt)("h2",{id:"4-configure-the-environment-with-basic-clusters-using-clickhouse-keeper"},"4. Configure the environment with basic clusters using ClickHouse Keeper"),(0,r.kt)("p",null,"For this deployment environment, the following ClickHouse Keeper settings are used in each node. Each server will have its own ",(0,r.kt)("inlineCode",{parentName:"p"},"<server_id>"),". (For example, ",(0,r.kt)("inlineCode",{parentName:"p"},"<server_id>1</server_id>")," for node ",(0,r.kt)("inlineCode",{parentName:"p"},"chnode1"),", and so on.)"),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"Recommended port is ",(0,r.kt)("inlineCode",{parentName:"p"},"9281")," for ClickHouse Keeper. However, the port is configurable and can be set if this port is in use already by another application in the environment."),(0,r.kt)("p",{parentName:"admonition"},"For a full explanation of all options, visit ",(0,r.kt)("a",{parentName:"p",href:"https://clickhouse.com/docs/en/operations/clickhouse-keeper/"},"https://clickhouse.com/docs/en/operations/clickhouse-keeper/"))),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Add the following inside the ",(0,r.kt)("inlineCode",{parentName:"p"},"<clickhouse>")," tag in ClickHouse server ",(0,r.kt)("inlineCode",{parentName:"p"},"config.xml")),(0,r.kt)("admonition",{parentName:"li",type:"note"},(0,r.kt)("p",{parentName:"admonition"},"For production environments, it is recommended to use a separate ",(0,r.kt)("inlineCode",{parentName:"p"},".xml")," config file in the ",(0,r.kt)("inlineCode",{parentName:"p"},"config.d")," directory.\nFor more information, visit ",(0,r.kt)("a",{parentName:"p",href:"https://clickhouse.com/docs/en/operations/configuration-files/"},"https://clickhouse.com/docs/en/operations/configuration-files/"))),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-xml"},"<keeper_server>\n    <tcp_port_secure>9281</tcp_port_secure>\n    <server_id>1</server_id>\n    <log_storage_path>/var/lib/clickhouse/coordination/log</log_storage_path>\n    <snapshot_storage_path>/var/lib/clickhouse/coordination/snapshots</snapshot_storage_path>\n\n    <coordination_settings>\n        <operation_timeout_ms>10000</operation_timeout_ms>\n        <session_timeout_ms>30000</session_timeout_ms>\n        <raft_logs_level>trace</raft_logs_level>\n    </coordination_settings>\n\n    <raft_configuration>\n        <server>\n            <id>1</id>\n            <hostname>chnode1.marsnet.local</hostname>\n            <port>9444</port>\n            <secure>1</secure>\n        </server>\n        <server>\n            <id>2</id>\n            <hostname>chnode2.marsnet.local</hostname>\n            <port>9444</port>\n            <secure>1</secure>\n        </server>\n        <server>\n            <id>3</id>\n            <hostname>chnode3.marsnet.local</hostname>\n            <port>9444</port>\n            <secure>1</secure>\n        </server>\n    </raft_configuration>\n</keeper_server>\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Uncomment and update the keeper settings on all nodes and set the ",(0,r.kt)("inlineCode",{parentName:"p"},"<secure>")," flag to 1:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-xml"},"<zookeeper>\n    <node>\n        <host>chnode1.marsnet.local</host>\n        <port>9281</port>\n        <secure>1</secure>\n    </node>\n    <node>\n        <host>chnode2.marsnet.local</host>\n        <port>9281</port>\n        <secure>1</secure>\n    </node>\n    <node>\n        <host>chnode3.marsnet.local</host>\n        <port>9281</port>\n        <secure>1</secure>\n    </node>\n</zookeeper>\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Update and add the following cluster settings to ",(0,r.kt)("inlineCode",{parentName:"p"},"chnode1")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"chnode2"),". ",(0,r.kt)("inlineCode",{parentName:"p"},"chnode3")," will be used for the ClickHouse Keeper quorum."),(0,r.kt)("admonition",{parentName:"li",type:"note"},(0,r.kt)("p",{parentName:"admonition"},"For this configuration, only one example cluster is configured. The test sample clusters must be either removed, commented out or if an existing cluster exists that is being tested, then the port must be updated and the ",(0,r.kt)("inlineCode",{parentName:"p"},"<secure>")," option must be added. The ",(0,r.kt)("inlineCode",{parentName:"p"},"<user")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"<password>")," must be set if the ",(0,r.kt)("inlineCode",{parentName:"p"},"default")," user was initially configured to have a password in the installation or in the ",(0,r.kt)("inlineCode",{parentName:"p"},"users.xml")," file.")),(0,r.kt)("p",{parentName:"li"},"The following creates a cluster with one shard replica on two servers (one on each node)."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-xml"},"<remote_servers>\n    <cluster_1S_2R>\n        <shard>\n            <replica>\n                <host>chnode1.marsnet.local</host>\n                <port>9440</port>\n                <user>default</user>\n                <password>ClickHouse123!</password>\n                <secure>1</secure>\n            </replica>\n            <replica>\n                <host>chnode2.marsnet.local</host>\n                <port>9440</port>\n                <user>default</user>\n                <password>ClickHouse123!</password>\n                <secure>1</secure>\n            </replica>\n        </shard>\n    </cluster_1S_2R>\n</remote_servers>\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Define macros values to be able to create a ReplicatedMergeTree table for testing. On ",(0,r.kt)("inlineCode",{parentName:"p"},"chnode1"),":"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-xml"},"<macros>\n    <shard>1</shard>\n    <replica>replica_1</replica>\n</macros>\n")),(0,r.kt)("p",{parentName:"li"},"On ",(0,r.kt)("inlineCode",{parentName:"p"},"chnode2"),":"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-xml"},"<macros>\n    <shard>1</shard>\n    <replica>replica_2</replica>\n</macros>\n")))),(0,r.kt)("h2",{id:"5-configure-ssl-tls-interfaces-on-clickhouse-nodes"},"5. Configure SSL-TLS interfaces on ClickHouse nodes"),(0,r.kt)("p",null,"The settings below are configured in the ClickHouse server ",(0,r.kt)("inlineCode",{parentName:"p"},"config.xml")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Set the display name for the deployment (optional):"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-xml"},"<display_name>clickhouse</display_name>\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Set ClickHouse to listen on external ports:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-xml"},"<listen_host>0.0.0.0</listen_host>\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Configure the ",(0,r.kt)("inlineCode",{parentName:"p"},"https")," port and disable the ",(0,r.kt)("inlineCode",{parentName:"p"},"http")," port on each node:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-xml"},"<https_port>8443</https_port>\n\x3c!--<http_port>8123</http_port>--\x3e\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Configure the ClickHouse Native secure TCP port and disable the default non-secure port on each node:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-xml"},"<tcp_port_secure>9440</tcp_port_secure>\n\x3c!--<tcp_port>9000</tcp_port>--\x3e\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Configure the ",(0,r.kt)("inlineCode",{parentName:"p"},"interserver https")," port and disable the default non-secure port on each node:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-xml"},"<interserver_https_port>9010</interserver_https_port>\n\x3c!--<interserver_http_port>9009</interserver_http_port>--\x3e\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Configure OpenSSL with certificates and paths"),(0,r.kt)("admonition",{parentName:"li",type:"note"},(0,r.kt)("p",{parentName:"admonition"},"Each filename and path must be updated to match the node that it is being configured on.\nFor example, update the ",(0,r.kt)("inlineCode",{parentName:"p"},"<certificateFile>")," entry to be ",(0,r.kt)("inlineCode",{parentName:"p"},"chnode2.crt")," when configuring in ",(0,r.kt)("inlineCode",{parentName:"p"},"chnode2")," host.")),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-xml"},"<openSSL>\n    <server>\n        <certificateFile>/etc/clickhouse-server/certs/chnode1.crt</certificateFile>\n        <privateKeyFile>/etc/clickhouse-server/certs/chnode1.key</privateKeyFile>\n        <verificationMode>relaxed</verificationMode>\n        <caConfig>/etc/clickhouse-server/certs/marsnet_ca.crt</caConfig>\n        <cacheSessions>true</cacheSessions>\n        <disableProtocols>sslv2,sslv3</disableProtocols>\n        <preferServerCiphers>true</preferServerCiphers>\n    </server>\n    <client>\n        <loadDefaultCAFile>false</loadDefaultCAFile>\n        <caConfig>/etc/clickhouse-server/certs/marsnet_ca.crt</caConfig>\n        <cacheSessions>true</cacheSessions>\n        <disableProtocols>sslv2,sslv3</disableProtocols>\n        <preferServerCiphers>true</preferServerCiphers>\n        <verificationMode>relaxed</verificationMode>\n        <invalidCertificateHandler>\n            <name>RejectCertificateHandler</name>\n        </invalidCertificateHandler>\n    </client>\n</openSSL>\n")),(0,r.kt)("p",{parentName:"li"},"For more information, visit ",(0,r.kt)("a",{parentName:"p",href:"https://clickhouse.com/docs/en/operations/server-configuration-parameters/settings/#server_configuration_parameters-openssl"},"https://clickhouse.com/docs/en/operations/server-configuration-parameters/settings/#server_configuration_parameters-openssl")))),(0,r.kt)("ol",{start:7},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Configure gRPC for SSL on every node:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-xml"},"<grpc>\n    <enable_ssl>1</enable_ssl>\n    <ssl_cert_file>/etc/clickhouse-server/certs/chnode1.crt</ssl_cert_file>\n    <ssl_key_file>/etc/clickhouse-server/certs/chnode1.key</ssl_key_file>\n    <ssl_require_client_auth>true</ssl_require_client_auth>\n    <ssl_ca_cert_file>/etc/clickhouse-server/certs/marsnet_ca.crt</ssl_ca_cert_file>\n    <transport_compression_type>none</transport_compression_type>\n    <transport_compression_level>0</transport_compression_level>\n    <max_send_message_size>-1</max_send_message_size>\n    <max_receive_message_size>-1</max_receive_message_size>\n    <verbose_logs>false</verbose_logs>\n</grpc>\n")),(0,r.kt)("p",{parentName:"li"},"For more information, visit ",(0,r.kt)("a",{parentName:"p",href:"https://clickhouse.com/docs/en/interfaces/grpc/"},"https://clickhouse.com/docs/en/interfaces/grpc/"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Configure ClickHouse client on at least one of the nodes to use SSL for connections in its own ",(0,r.kt)("inlineCode",{parentName:"p"},"config.xml")," file (by default in ",(0,r.kt)("inlineCode",{parentName:"p"},"/etc/clickhouse-client/"),"):"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-xml"},"<openSSL>\n    <client>\n        <loadDefaultCAFile>false</loadDefaultCAFile>\n        <caConfig>/etc/clickhouse-server/certs/marsnet_ca.crt</caConfig>\n        <cacheSessions>true</cacheSessions>\n        <disableProtocols>sslv2,sslv3</disableProtocols>\n        <preferServerCiphers>true</preferServerCiphers>\n        <invalidCertificateHandler>\n            <name>RejectCertificateHandler</name>\n        </invalidCertificateHandler>\n    </client>\n</openSSL>\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Disable default emulation ports for MySQL and PostgreSQL:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-xml"},"\x3c!--mysql_port>9004</mysql_port--\x3e\n\x3c!--postgresql_port>9005</postgresql_port--\x3e\n")))),(0,r.kt)("h2",{id:"6-testing"},"6. Testing"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Start all nodes, one at a time:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"service clickhouse-server start\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Verify secure ports are up and listening, should look similar to this example on each node:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"root@chnode1:/etc/clickhouse-server# netstat -ano | grep tcp\n")),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-response"},"tcp        0      0 0.0.0.0:9010            0.0.0.0:*               LISTEN      off (0.00/0/0)\ntcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      off (0.00/0/0)\ntcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      off (0.00/0/0)\ntcp        0      0 0.0.0.0:8443            0.0.0.0:*               LISTEN      off (0.00/0/0)\ntcp        0      0 0.0.0.0:9440            0.0.0.0:*               LISTEN      off (0.00/0/0)\ntcp        0      0 0.0.0.0:9281            0.0.0.0:*               LISTEN      off (0.00/0/0)\ntcp        0      0 192.168.1.221:33046     192.168.1.222:9444      ESTABLISHED off (0.00/0/0)\ntcp        0      0 192.168.1.221:42730     192.168.1.223:9444      ESTABLISHED off (0.00/0/0)\ntcp        0      0 192.168.1.221:51952     192.168.1.222:9281      ESTABLISHED off (0.00/0/0)\ntcp        0      0 192.168.1.221:22        192.168.1.210:49801     ESTABLISHED keepalive (6618.05/0/0)\ntcp        0     64 192.168.1.221:22        192.168.1.210:59195     ESTABLISHED on (0.24/0/0)\ntcp6       0      0 :::22                   :::*                    LISTEN      off (0.00/0/0)\ntcp6       0      0 :::9444                 :::*                    LISTEN      off (0.00/0/0)\ntcp6       0      0 192.168.1.221:9444      192.168.1.222:59046     ESTABLISHED off (0.00/0/0)\ntcp6       0      0 192.168.1.221:9444      192.168.1.223:41976     ESTABLISHED off (0.00/0/0)\n")),(0,r.kt)("table",{parentName:"li"},(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"ClickHouse Port"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"8443"),(0,r.kt)("td",{parentName:"tr",align:null},"https interface")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"9010"),(0,r.kt)("td",{parentName:"tr",align:null},"interserver https port")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"9281"),(0,r.kt)("td",{parentName:"tr",align:null},"ClickHouse Keeper secure port")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"9440"),(0,r.kt)("td",{parentName:"tr",align:null},"secure Native TCP protocol")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"9444"),(0,r.kt)("td",{parentName:"tr",align:null},"ClickHouse Keeper Raft port"))))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Verify ClickHouse Keeper health\nThe typical ",(0,r.kt)("a",{parentName:"p",href:"/docs/en/operations/clickhouse-keeper/#four-letter-word-commands"},"4 letter word (4lW)")," commands will not work using ",(0,r.kt)("inlineCode",{parentName:"p"},"echo")," without TLS, here is how to use the commands with ",(0,r.kt)("inlineCode",{parentName:"p"},"openssl"),"."),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Start an interactive session with ",(0,r.kt)("inlineCode",{parentName:"p"},"openssl")),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"openssl s_client -connect chnode1.marsnet.local:9281\n")),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-response"},"CONNECTED(00000003)\ndepth=0 CN = chnode1\nverify error:num=20:unable to get local issuer certificate\nverify return:1\ndepth=0 CN = chnode1\nverify error:num=21:unable to verify the first certificate\nverify return:1\n---\nCertificate chain\n 0 s:CN = chnode1\n   i:CN = marsnet.local CA\n---\nServer certificate\n-----BEGIN CERTIFICATE-----\nMIICtDCCAZwCFD321grxU3G5pf6hjitf2u7vkusYMA0GCSqGSIb3DQEBCwUAMBsx\n...\n"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Send the 4LW commands in the openssl session"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"mntr\n")),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-response"},"---\nPost-Handshake New Session Ticket arrived:\nSSL-Session:\n    Protocol  : TLSv1.3\n...\nread R BLOCK\nzk_version      v22.7.3.5-stable-e140b8b5f3a5b660b6b576747063fd040f583cf3\nzk_avg_latency  0\n# highlight-next-line\nzk_max_latency  4087\nzk_min_latency  0\nzk_packets_received     4565774\nzk_packets_sent 4565773\nzk_num_alive_connections        2\nzk_outstanding_requests 0\n# highlight-next-line\nzk_server_state leader\nzk_znode_count  1087\nzk_watch_count  26\nzk_ephemerals_count     12\nzk_approximate_data_size        426062\nzk_key_arena_size       258048\nzk_latest_snapshot_size 0\nzk_open_file_descriptor_count   187\nzk_max_file_descriptor_count    18446744073709551615\n# highlight-next-line\nzk_followers    2\nzk_synced_followers     1\nclosed\n"))))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Start the ClickHouse client using ",(0,r.kt)("inlineCode",{parentName:"p"},"--secure")," flag and SSL port:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"root@chnode1:/etc/clickhouse-server# clickhouse-client --user default --password ClickHouse123! --port 9440 --secure --host chnode1.marsnet.local\nClickHouse client version 22.3.3.44 (official build).\nConnecting to chnode1.marsnet.local:9440 as user default.\nConnected to ClickHouse server version 22.3.3 revision 54455.\n\nclickhouse :)\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Log into the Play UI using the ",(0,r.kt)("inlineCode",{parentName:"p"},"https")," interface at ",(0,r.kt)("inlineCode",{parentName:"p"},"https://chnode1.marsnet.local:8443/play"),"."),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{alt:"Play UI",src:n(16828).Z,width:"724",height:"348"})),(0,r.kt)("admonition",{parentName:"li",type:"note"},(0,r.kt)("p",{parentName:"admonition"},"the browser will show an untrusted certificate since it is being reached from a workstation and the certificates are not in the root CA stores on the client machine.\nWhen using certificates issued from a public authority or enterprise CA, it should show trusted."))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Create a replicated table:"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"clickhouse :) CREATE TABLE repl_table ON CLUSTER cluster_1S_2R\n            (\n                id UInt64,\n                column1 Date,\n                column2 String\n            )\n            ENGINE = ReplicatedMergeTree('/clickhouse/tables/{shard}/default/repl_table', '{replica}' )\n            ORDER BY (id);\n")),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-response"},"\u250c\u2500host\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500port\u2500\u252c\u2500status\u2500\u252c\u2500error\u2500\u252c\u2500num_hosts_remaining\u2500\u252c\u2500num_hosts_active\u2500\u2510\n\u2502 chnode2.marsnet.local \u2502 9440 \u2502      0 \u2502       \u2502                   1 \u2502                0 \u2502\n\u2502 chnode1.marsnet.local \u2502 9440 \u2502      0 \u2502       \u2502                   0 \u2502                0 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Add a couple rows on ",(0,r.kt)("inlineCode",{parentName:"p"},"chnode1"),":"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"INSERT INTO repl_table\n(id, column1, column2)\nVALUES\n(1,'2022-04-01','abc'),\n(2,'2022-04-02','def');\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Verify the replication by viewing the rows on ",(0,r.kt)("inlineCode",{parentName:"p"},"chnode2"),":"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT * FROM repl_table\n")),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-response"},"\u250c\u2500id\u2500\u252c\u2500\u2500\u2500\u2500column1\u2500\u252c\u2500column2\u2500\u2510\n\u2502  1 \u2502 2022-04-01 \u2502 abc     \u2502\n\u2502  2 \u2502 2022-04-02 \u2502 def     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n")))),(0,r.kt)("h2",{id:"summary"},"Summary"),(0,r.kt)("p",null,"This article focused on getting a ClickHouse environment configured with SSL/TLS. The settings will differ for different requirements in production environments; for example, certificate verification levels, protocols, ciphers, etc. But you should now have a good understanding of the steps involved in configuring and implementing secure connections."))}u.isMDXComponent=!0},16828:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/configuring-ssl_01-d6fe846da3ad66c753f644f434d3519b.png"}}]);