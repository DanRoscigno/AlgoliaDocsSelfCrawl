"use strict";(self.webpackChunkclickhouse_docs_2_3_0=self.webpackChunkclickhouse_docs_2_3_0||[]).push([[2105],{3905:(e,t,a)=>{a.d(t,{Zo:()=>m,kt:()=>f});var n=a(67294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function l(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function s(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?l(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},l=Object.keys(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var o=n.createContext({}),p=function(e){var t=n.useContext(o),a=t;return e&&(a="function"==typeof e?e(t):s(s({},t),e)),a},m=function(e){var t=p(e.components);return n.createElement(o.Provider,{value:t},e.children)},u="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,l=e.originalType,o=e.parentName,m=i(e,["components","mdxType","originalType","parentName"]),u=p(a),d=r,f=u["".concat(o,".").concat(d)]||u[d]||c[d]||l;return a?n.createElement(f,s(s({ref:t},m),{},{components:a})):n.createElement(f,s({ref:t},m))}));function f(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=a.length,s=new Array(l);s[0]=d;var i={};for(var o in t)hasOwnProperty.call(t,o)&&(i[o]=t[o]);i.originalType=e,i[u]="string"==typeof e?e:r,s[1]=i;for(var p=2;p<l;p++)s[p]=a[p];return n.createElement.apply(null,s)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},13341:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>o,contentTitle:()=>s,default:()=>c,frontMatter:()=>l,metadata:()=>i,toc:()=>p});var n=a(87462),r=(a(67294),a(3905));const l={slug:"/en/sql-reference/statements/select/sample",sidebar_label:"SAMPLE"},s="SAMPLE Clause",i={unversionedId:"en/sql-reference/statements/select/sample",id:"en/sql-reference/statements/select/sample",title:"SAMPLE Clause",description:"The SAMPLE clause allows for approximated SELECT query processing.",source:"@site/docs/en/sql-reference/statements/select/sample.md",sourceDirName:"en/sql-reference/statements/select",slug:"/en/sql-reference/statements/select/sample",permalink:"/docs/en/sql-reference/statements/select/sample",draft:!1,editUrl:"https://github.com/ClickHouse/ClickHouse/tree/master/docs/en/sql-reference/statements/select/sample.md",tags:[],version:"current",frontMatter:{slug:"/en/sql-reference/statements/select/sample",sidebar_label:"SAMPLE"},sidebar:"english",previous:{title:"PREWHERE",permalink:"/docs/en/sql-reference/statements/select/prewhere"},next:{title:"UNION",permalink:"/docs/en/sql-reference/statements/select/union"}},o={},p=[{value:"SAMPLE K",id:"sample-k",level:2},{value:"SAMPLE N",id:"sample-n",level:2},{value:"SAMPLE K OFFSET M",id:"sample-k-offset-m",level:2}],m={toc:p},u="wrapper";function c(e){let{components:t,...a}=e;return(0,r.kt)(u,(0,n.Z)({},m,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"sample-clause"},"SAMPLE Clause"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"SAMPLE")," clause allows for approximated ",(0,r.kt)("inlineCode",{parentName:"p"},"SELECT")," query processing."),(0,r.kt)("p",null,"When data sampling is enabled, the query is not performed on all the data, but only on a certain fraction of data (sample). For example, if you need to calculate statistics for all the visits, it is enough to execute the query on the 1/10 fraction of all the visits and then multiply the result by 10."),(0,r.kt)("p",null,"Approximated query processing can be useful in the following cases:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"When you have strict latency requirements (like below 100ms) but you can\u2019t justify the cost of additional hardware resources to meet them."),(0,r.kt)("li",{parentName:"ul"},"When your raw data is not accurate, so approximation does not noticeably degrade the quality."),(0,r.kt)("li",{parentName:"ul"},"Business requirements target approximate results (for cost-effectiveness, or to market exact results to premium users).")),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"You can only use sampling with the tables in the ",(0,r.kt)("a",{parentName:"p",href:"/docs/en/engines/table-engines/mergetree-family/mergetree"},"MergeTree")," family, and only if the sampling expression was specified during table creation (see ",(0,r.kt)("a",{parentName:"p",href:"/docs/en/engines/table-engines/mergetree-family/mergetree#table_engine-mergetree-creating-a-table"},"MergeTree engine"),").")),(0,r.kt)("p",null,"The features of data sampling are listed below:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Data sampling is a deterministic mechanism. The result of the same ",(0,r.kt)("inlineCode",{parentName:"li"},"SELECT .. SAMPLE")," query is always the same."),(0,r.kt)("li",{parentName:"ul"},"Sampling works consistently for different tables. For tables with a single sampling key, a sample with the same coefficient always selects the same subset of possible data. For example, a sample of user IDs takes rows with the same subset of all the possible user IDs from different tables. This means that you can use the sample in subqueries in the ",(0,r.kt)("a",{parentName:"li",href:"/docs/en/sql-reference/operators/in"},"IN")," clause. Also, you can join samples using the ",(0,r.kt)("a",{parentName:"li",href:"/docs/en/sql-reference/statements/select/join"},"JOIN")," clause."),(0,r.kt)("li",{parentName:"ul"},"Sampling allows reading less data from a disk. Note that you must specify the sampling key correctly. For more information, see ",(0,r.kt)("a",{parentName:"li",href:"/docs/en/engines/table-engines/mergetree-family/mergetree#table_engine-mergetree-creating-a-table"},"Creating a MergeTree Table"),".")),(0,r.kt)("p",null,"For the ",(0,r.kt)("inlineCode",{parentName:"p"},"SAMPLE")," clause the following syntax is supported:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"SAMPLE\xa0Clause\xa0Syntax"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"SAMPLE k")),(0,r.kt)("td",{parentName:"tr",align:null},"Here ",(0,r.kt)("inlineCode",{parentName:"td"},"k")," is the number from 0 to 1. The query is executed on ",(0,r.kt)("inlineCode",{parentName:"td"},"k")," fraction of data. For example, ",(0,r.kt)("inlineCode",{parentName:"td"},"SAMPLE 0.1")," runs the query on 10% of data. ",(0,r.kt)("a",{parentName:"td",href:"#select-sample-k"},"Read more"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"SAMPLE n")),(0,r.kt)("td",{parentName:"tr",align:null},"Here ",(0,r.kt)("inlineCode",{parentName:"td"},"n")," is a sufficiently large integer. The query is executed on a sample of at least ",(0,r.kt)("inlineCode",{parentName:"td"},"n")," rows (but not significantly more than this). For example, ",(0,r.kt)("inlineCode",{parentName:"td"},"SAMPLE 10000000")," runs the query on a minimum of 10,000,000 rows. ",(0,r.kt)("a",{parentName:"td",href:"#select-sample-n"},"Read more"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"SAMPLE k OFFSET m")),(0,r.kt)("td",{parentName:"tr",align:null},"Here ",(0,r.kt)("inlineCode",{parentName:"td"},"k")," and ",(0,r.kt)("inlineCode",{parentName:"td"},"m")," are the numbers from 0 to 1. The query is executed on a sample of ",(0,r.kt)("inlineCode",{parentName:"td"},"k")," fraction of the data. The data used for the sample is offset by ",(0,r.kt)("inlineCode",{parentName:"td"},"m")," fraction. ",(0,r.kt)("a",{parentName:"td",href:"#select-sample-offset"},"Read more"))))),(0,r.kt)("h2",{id:"sample-k"},"SAMPLE K"),(0,r.kt)("p",null,"Here ",(0,r.kt)("inlineCode",{parentName:"p"},"k")," is the number from 0 to 1 (both fractional and decimal notations are supported). For example, ",(0,r.kt)("inlineCode",{parentName:"p"},"SAMPLE 1/2")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"SAMPLE 0.5"),"."),(0,r.kt)("p",null,"In a ",(0,r.kt)("inlineCode",{parentName:"p"},"SAMPLE k")," clause, the sample is taken from the ",(0,r.kt)("inlineCode",{parentName:"p"},"k")," fraction of data. The example is shown below:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\n    Title,\n    count() * 10 AS PageViews\nFROM hits_distributed\nSAMPLE 0.1\nWHERE\n    CounterID = 34\nGROUP BY Title\nORDER BY PageViews DESC LIMIT 1000\n")),(0,r.kt)("p",null,"In this example, the query is executed on a sample from 0.1 (10%) of data. Values of aggregate functions are not corrected automatically, so to get an approximate result, the value ",(0,r.kt)("inlineCode",{parentName:"p"},"count()")," is manually multiplied by 10."),(0,r.kt)("h2",{id:"sample-n"},"SAMPLE N"),(0,r.kt)("p",null,"Here ",(0,r.kt)("inlineCode",{parentName:"p"},"n")," is a sufficiently large integer. For example, ",(0,r.kt)("inlineCode",{parentName:"p"},"SAMPLE 10000000"),"."),(0,r.kt)("p",null,"In this case, the query is executed on a sample of at least ",(0,r.kt)("inlineCode",{parentName:"p"},"n")," rows (but not significantly more than this). For example, ",(0,r.kt)("inlineCode",{parentName:"p"},"SAMPLE 10000000")," runs the query on a minimum of 10,000,000 rows."),(0,r.kt)("p",null,"Since the minimum unit for data reading is one granule (its size is set by the ",(0,r.kt)("inlineCode",{parentName:"p"},"index_granularity")," setting), it makes sense to set a sample that is much larger than the size of the granule."),(0,r.kt)("p",null,"When using the ",(0,r.kt)("inlineCode",{parentName:"p"},"SAMPLE n")," clause, you do not know which relative percent of data was processed. So you do not know the coefficient the aggregate functions should be multiplied by. Use the ",(0,r.kt)("inlineCode",{parentName:"p"},"_sample_factor")," virtual column to get the approximate result."),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"_sample_factor")," column contains relative coefficients that are calculated dynamically. This column is created automatically when you ",(0,r.kt)("a",{parentName:"p",href:"/docs/en/engines/table-engines/mergetree-family/mergetree#table_engine-mergetree-creating-a-table"},"create")," a table with the specified sampling key. The usage examples of the ",(0,r.kt)("inlineCode",{parentName:"p"},"_sample_factor")," column are shown below."),(0,r.kt)("p",null,"Let\u2019s consider the table ",(0,r.kt)("inlineCode",{parentName:"p"},"visits"),", which contains the statistics about site visits. The first example shows how to calculate the number of page views:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT sum(PageViews * _sample_factor)\nFROM visits\nSAMPLE 10000000\n")),(0,r.kt)("p",null,"The next example shows how to calculate the total number of visits:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT sum(_sample_factor)\nFROM visits\nSAMPLE 10000000\n")),(0,r.kt)("p",null,"The example below shows how to calculate the average session duration. Note that you do not need to use the relative coefficient to calculate the average values."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT avg(Duration)\nFROM visits\nSAMPLE 10000000\n")),(0,r.kt)("h2",{id:"sample-k-offset-m"},"SAMPLE K OFFSET M"),(0,r.kt)("p",null,"Here ",(0,r.kt)("inlineCode",{parentName:"p"},"k")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"m")," are numbers from 0 to 1. Examples are shown below."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Example 1")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SAMPLE 1/10\n")),(0,r.kt)("p",null,"In this example, the sample is 1/10th of all data:"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"[++------------]")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Example 2")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SAMPLE 1/10 OFFSET 1/2\n")),(0,r.kt)("p",null,"Here, a sample of 10% is taken from the second half of the data."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"[------++------]")))}c.isMDXComponent=!0}}]);