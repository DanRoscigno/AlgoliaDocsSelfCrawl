"use strict";(self.webpackChunkclickhouse_docs_2_3_0=self.webpackChunkclickhouse_docs_2_3_0||[]).push([[25624],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>h});var r=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var c=r.createContext({}),l=function(e){var t=r.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},u=function(e){var t=l(e.components);return r.createElement(c.Provider,{value:t},e.children)},p="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,c=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),p=l(n),d=a,h=p["".concat(c,".").concat(d)]||p[d]||m[d]||i;return n?r.createElement(h,s(s({ref:t},u),{},{components:n})):r.createElement(h,s({ref:t},u))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,s=new Array(i);s[0]=d;var o={};for(var c in t)hasOwnProperty.call(t,c)&&(o[c]=t[c]);o.originalType=e,o[p]="string"==typeof e?e:a,s[1]=o;for(var l=2;l<i;l++)s[l]=n[l];return r.createElement.apply(null,s)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},10331:(e,t,n)=>{n.d(t,{ZP:()=>o});var r=n(87462),a=(n(67294),n(3905));const i={toc:[]},s="wrapper";function o(e){let{components:t,...n}=e;return(0,a.kt)(s,(0,r.Z)({},i,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("admonition",{type:"note"},(0,a.kt)("p",{parentName:"admonition"},"This page is not applicable to ",(0,a.kt)("a",{parentName:"p",href:"https://clickhouse.com/cloud"},"ClickHouse Cloud"),". The feature documented here is not available in ClickHouse Cloud services.\nSee the ClickHouse ",(0,a.kt)("a",{parentName:"p",href:"/docs/en/whats-new/cloud-compatibility"},"Cloud Compatibility")," guide for more information.")))}o.isMDXComponent=!0},38019:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>s,metadata:()=>c,toc:()=>u});var r=n(87462),a=(n(67294),n(3905)),i=n(10331);const s={sidebar_label:"SSL User Certificate Authentication",sidebar_position:20,slug:"/en/guides/sre/ssl-user-auth"},o="Configuring SSL User Certificate for Authentication",c={unversionedId:"en/guides/sre/user-management/ssl-user-auth",id:"en/guides/sre/user-management/ssl-user-auth",title:"Configuring SSL User Certificate for Authentication",description:"This guide provides simple and minimal settings to configure authentication with SSL user certificates. The tutorial builds on the Configuring SSL-TLS user guide.",source:"@site/docs/en/guides/sre/user-management/ssl-user-auth.md",sourceDirName:"en/guides/sre/user-management",slug:"/en/guides/sre/ssl-user-auth",permalink:"/AlgoliaDocsSelfCrawl/en/guides/sre/ssl-user-auth",draft:!1,editUrl:"https://github.com/ClickHouse/clickhouse-docs/blob/main/docs/en/guides/sre/user-management/ssl-user-auth.md",tags:[],version:"current",sidebarPosition:20,frontMatter:{sidebar_label:"SSL User Certificate Authentication",sidebar_position:20,slug:"/en/guides/sre/ssl-user-auth"},sidebar:"english",previous:{title:"Configuring LDAP",permalink:"/AlgoliaDocsSelfCrawl/en/guides/sre/configuring-ldap"},next:{title:"Defining SQL Users and Roles",permalink:"/AlgoliaDocsSelfCrawl/en/guides/sre/users-and-roles"}},l={},u=[{value:"1. Create SSL user certificates",id:"1-create-ssl-user-certificates",level:2},{value:"2. Create a SQL user and grant permissions",id:"2-create-a-sql-user-and-grant-permissions",level:2},{value:"3. Testing",id:"3-testing",level:2},{value:"Summary",id:"summary",level:2}],p={toc:u},m="wrapper";function d(e){let{components:t,...n}=e;return(0,a.kt)(m,(0,r.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"configuring-ssl-user-certificate-for-authentication"},"Configuring SSL User Certificate for Authentication"),(0,a.kt)(i.ZP,{mdxType:"SelfManaged"}),(0,a.kt)("p",null,"This guide provides simple and minimal settings to configure authentication with SSL user certificates. The tutorial builds on the ",(0,a.kt)("a",{parentName:"p",href:"/AlgoliaDocsSelfCrawl/en/guides/sre/configuring-ssl"},"Configuring SSL-TLS user guide"),"."),(0,a.kt)("admonition",{type:"note"},(0,a.kt)("p",{parentName:"admonition"},"SSL user authentication is supported when using the ",(0,a.kt)("inlineCode",{parentName:"p"},"https")," interface only.\nIt is not currently used in the native protocol with the ClickHouse client, gRPC or PostgreSQL/MySQL emulation ports."),(0,a.kt)("p",{parentName:"admonition"},"ClickHouse nodes need ",(0,a.kt)("inlineCode",{parentName:"p"},"<verificationMode>strict</verificationMode>")," set for secure authentication (although ",(0,a.kt)("inlineCode",{parentName:"p"},"relaxed")," will work for testing purposes).")),(0,a.kt)("h2",{id:"1-create-ssl-user-certificates"},"1. Create SSL user certificates"),(0,a.kt)("admonition",{type:"note"},(0,a.kt)("p",{parentName:"admonition"},"This example uses self-signed certificates with a self-signed CA. For production environments, create a CSR and submit to your PKI team or certificate provider to obtain a proper certificate.")),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Generate a Certificate Signing Request (CSR) and key. The basic format is the following:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'openssl req -newkey rsa:2048 -nodes -subj "/CN=<my_host>:<my_user>"  -keyout <my_cert_name>.key -out <my_cert_name>.csr\n')),(0,a.kt)("p",{parentName:"li"},"In this example, we'll use this for the domain and user that will be used in this sample environment:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'openssl req -newkey rsa:2048 -nodes -subj "/CN=chnode1.marsnet.local:cert_user"  -keyout chnode1_cert_user.key -out chnode1_cert_user.csr\n')),(0,a.kt)("admonition",{parentName:"li",type:"note"},(0,a.kt)("p",{parentName:"admonition"},"The CN is arbitrary and any string can be used as an identifier for the certicate. It is used when creating the user in the following steps."))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Generate and sign the new user certificate that will be used for authentication. The basic format is the following:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"openssl x509 -req -in <my_cert_name>.csr -out <my_cert_name>.crt -CAcreateserial -CA <my_ca_cert>.crt -CAkey <my_ca_cert>.key -days 365\n")),(0,a.kt)("p",{parentName:"li"},"In this example, we'll use this for the domain and user that will be used in this sample environment:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"openssl x509 -req -in chnode1_cert_user.csr -out chnode1_cert_user.crt -CAcreateserial -CA marsnet_ca.crt -CAkey marsnet_ca.key -days 365\n")))),(0,a.kt)("h2",{id:"2-create-a-sql-user-and-grant-permissions"},"2. Create a SQL user and grant permissions"),(0,a.kt)("admonition",{type:"note"},(0,a.kt)("p",{parentName:"admonition"},"For details on how to enable SQL users and set roles, refer to ",(0,a.kt)("a",{parentName:"p",href:"/AlgoliaDocsSelfCrawl/en/guides/sre/users-and-roles"},"Defining SQL Users and Roles")," user guide.")),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Create a SQL user defined to use the certiciate authentication:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE USER cert_user IDENTIFIED WITH ssl_certificate CN 'chnode1.marsnet.local:cert_user';\n"))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Grant privileges to the new certicate user:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-sql"},"GRANT ALL ON *.* TO cert_user WITH GRANT OPTION;\n")),(0,a.kt)("admonition",{parentName:"li",type:"note"},(0,a.kt)("p",{parentName:"admonition"},"The user is granted full admin privileges in this exercise for demostration purposes. Refer to the ClickHouse ",(0,a.kt)("a",{parentName:"p",href:"/AlgoliaDocsSelfCrawl/en/operations/access-rights"},"RBAC documentation")," for permissions settings.")),(0,a.kt)("admonition",{parentName:"li",type:"note"},(0,a.kt)("p",{parentName:"admonition"},"We recommend using SQL to define users and roles. However, if you are currently defining users and roles in configuration files, the user will look like:"),(0,a.kt)("pre",{parentName:"admonition"},(0,a.kt)("code",{parentName:"pre",className:"language-xml"},"<users>\n    <cert_user>\n        <ssl_certificates>\n            <common_name>chnode1.marsnet.local:cert_user</common_name>\n        </ssl_certificates>\n        <networks>\n            <ip>::/0</ip>\n        </networks>\n        <profile>default</profile>\n        <access_management>1</access_management>\n        \x3c!-- additional options--\x3e\n    </cert_user>\n</users>\n"))))),(0,a.kt)("h2",{id:"3-testing"},"3. Testing"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Copy the user certificate, user key and CA certificate to a remote node.")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Use ",(0,a.kt)("inlineCode",{parentName:"p"},"curl")," to test a sample SQL command. The basic format is:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"echo 'SHOW TABLES' | curl 'https://<clickhouse_node>:8443' --cert <my_cert_name>.crt --key <my_cert_name>.key --cacert <my_ca_cert>.crt -H \"X-ClickHouse-SSL-Certificate-Auth: on\" -H \"X-ClickHouse-User: <my_user>\" --data-binary @-\n")),(0,a.kt)("p",{parentName:"li"},"For example:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"echo 'SHOW TABLES' | curl 'https://chnode1:8443' --cert chnode1_cert_user.crt --key chnode1_cert_user.key --cacert marsnet_ca.crt -H \"X-ClickHouse-SSL-Certificate-Auth: on\" -H \"X-ClickHouse-User: cert_user\" --data-binary @-\n")),(0,a.kt)("p",{parentName:"li"},"The output will be similar to the following:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-response"},"INFORMATION_SCHEMA\ndefault\ninformation_schema\nsystem\n")),(0,a.kt)("admonition",{parentName:"li",type:"note"},(0,a.kt)("p",{parentName:"admonition"},"Notice that no password was specified, the certificate is used in lieu of a password and is how ClickHouse will authenticate the user.")))),(0,a.kt)("h2",{id:"summary"},"Summary"),(0,a.kt)("p",null,"This article showed the basics of creating and configuring a user for SSL certificate authentication. This method can be used with any clients which support the ",(0,a.kt)("inlineCode",{parentName:"p"},"https")," interface and where HTTP headers can be set. The generated certicate and key should be kept private and with limited access since the certificate is used to authenticate and authorize the user for operations on the ClickHouse database. Treat the certificate and key as if they were passwords."))}d.isMDXComponent=!0}}]);