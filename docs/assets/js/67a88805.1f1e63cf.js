"use strict";(self.webpackChunkclickhouse_docs_2_3_0=self.webpackChunkclickhouse_docs_2_3_0||[]).push([[50813],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>m});var a=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=a.createContext({}),d=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=d(e.components);return a.createElement(l.Provider,{value:t},e.children)},u="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=d(n),h=o,m=u["".concat(l,".").concat(h)]||u[h]||c[h]||r;return n?a.createElement(m,i(i({ref:t},p),{},{components:n})):a.createElement(m,i({ref:t},p))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[u]="string"==typeof e?e:o,i[1]=s;for(var d=2;d<r;d++)i[d]=n[d];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},14653:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>c,frontMatter:()=>r,metadata:()=>s,toc:()=>d});var a=n(87462),o=(n(67294),n(3905));const r={slug:"/en/guides/developer/working-with-json/json-load-data",sidebar_label:"Tutorial: Loading JSON",sidebar_position:1,description:"Loading JSON into ClickHouse",toc_max_heading_level:2},i="Loading JSON in 5 steps",s={unversionedId:"en/guides/developer/working-with-json/json-load-data",id:"en/guides/developer/working-with-json/json-load-data",title:"Loading JSON in 5 steps",description:"Loading JSON into ClickHouse",source:"@site/docs/en/guides/developer/working-with-json/json-load-data.md",sourceDirName:"en/guides/developer/working-with-json",slug:"/en/guides/developer/working-with-json/json-load-data",permalink:"/docs/en/guides/developer/working-with-json/json-load-data",draft:!1,editUrl:"https://github.com/ClickHouse/clickhouse-docs/blob/main/docs/en/guides/developer/working-with-json/json-load-data.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{slug:"/en/guides/developer/working-with-json/json-load-data",sidebar_label:"Tutorial: Loading JSON",sidebar_position:1,description:"Loading JSON into ClickHouse",toc_max_heading_level:2},sidebar:"english",previous:{title:"JSON",permalink:"/docs/en/guides/developer/working-with-json"},next:{title:"Handling JSON",permalink:"/docs/en/guides/developer/working-with-json/json-intro"}},l={},d=[{value:"Examine the structure of the JSON file",id:"examine-the-structure-of-the-json-file",level:2},{value:"DESCRIBE",id:"describe",level:4},{value:"SELECT",id:"select",level:4},{value:"Create a ClickHouse table",id:"create-a-clickhouse-table",level:2},{value:"Describe the table and note the <code>request</code> column",id:"describe-the-table-and-note-the-request-column",level:3},{value:"Insert one row",id:"insert-one-row",level:2},{value:"Verify",id:"verify",level:2},{value:"Insert the dataset",id:"insert-the-dataset",level:2},{value:"Query the data",id:"query-the-data",level:2},{value:"More information",id:"more-information",level:2},{value:"Limitations and other approaches",id:"limitations-and-other-approaches",level:3},{value:"JSON input and output formats",id:"json-input-and-output-formats",level:3}],p={toc:d},u="wrapper";function c(e){let{components:t,...n}=e;return(0,o.kt)(u,(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"loading-json-in-5-steps"},"Loading JSON in 5 steps"),(0,o.kt)("p",null,"This guide walks through the process to load logging data that is\nin a JSON formatted file in S3.  In order to do this:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Examine the file format by selecting one row using the S3 function"),(0,o.kt)("li",{parentName:"ul"},"Create a table to store the data in ClickHouse"),(0,o.kt)("li",{parentName:"ul"},"Load a single row of nested JSON"),(0,o.kt)("li",{parentName:"ul"},"Verify the correct storage of the nested JSON"),(0,o.kt)("li",{parentName:"ul"},"Import the dataset from S3")),(0,o.kt)("admonition",{type:"note"},(0,o.kt)("p",{parentName:"admonition"},"This tutorial requires ClickHouse version 22.11 or higher.")),(0,o.kt)("h2",{id:"examine-the-structure-of-the-json-file"},"Examine the structure of the JSON file"),(0,o.kt)("p",null,"Examine the structure and one record from the log file in S3.  The ",(0,o.kt)("inlineCode",{parentName:"p"},"s3")," function\nretrieves and decompresses the file and allows querying the file\nin S3 without loading it."),(0,o.kt)("p",null,"This is what a row of the file contains:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{"@timestamp":893964617,"clientip":"40.135.0.0","request":{"method":"GET","path":"/images/hm_bg.jpg","version":"HTTP/1.0"},"status":200,"size":24736}\n')),(0,o.kt)("p",null,"It is also very useful to look at the description of the file returned by the DESCRIBE command and a SELECT."),(0,o.kt)("h4",{id:"describe"},"DESCRIBE"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"DESCRIBE s3('https://datasets-documentation.s3.eu-west-3.amazonaws.com/http/documents-01.ndjson.gz', \n'JSONEachRow');\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-response"},"\u250c\u2500name\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500type\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500default_type\u2500\u252c\u2500default_expression\u2500\u252c\u2500comment\u2500\u252c\u2500codec_expression\u2500\u252c\u2500ttl_expression\u2500\u2510\n\u2502 @timestamp \u2502 Nullable(Int64)               \u2502              \u2502                    \u2502         \u2502                  \u2502                \u2502\n\u2502 clientip   \u2502 Nullable(String)              \u2502              \u2502                    \u2502         \u2502                  \u2502                \u2502\n\u2502 request    \u2502 Map(String, Nullable(String)) \u2502              \u2502                    \u2502         \u2502                  \u2502                \u2502\n\u2502 status     \u2502 Nullable(Int64)               \u2502              \u2502                    \u2502         \u2502                  \u2502                \u2502\n\u2502 size       \u2502 Nullable(Int64)               \u2502              \u2502                    \u2502         \u2502                  \u2502                \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n")),(0,o.kt)("h4",{id:"select"},"SELECT"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT * FROM s3('https://datasets-documentation.s3.eu-west-3.amazonaws.com/http/documents-01.ndjson.gz', \n'JSONEachRow') LIMIT 1;\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-response"},"\u250c\u2500@timestamp\u2500\u252c\u2500clientip\u2500\u2500\u2500\u252c\u2500request\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500status\u2500\u252c\u2500\u2500size\u2500\u2510\n\u2502  893964617 \u2502 40.135.0.0 \u2502 {'method':'GET','path':'/images/hm_bg.jpg','version':'HTTP/1.0'} \u2502    200 \u2502 24736 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n")),(0,o.kt)("p",null,"Note that the ",(0,o.kt)("inlineCode",{parentName:"p"},"response")," field contains nested JSON, it is more\nefficient for the users of the log data if that JSON is also extracted\ninto separate fields. The next two steps will be performed with this\noptimization in mind."),(0,o.kt)("h2",{id:"create-a-clickhouse-table"},"Create a ClickHouse table"),(0,o.kt)("p",null,"To maximize the usefulness of the data we\nneed to extract the nested ",(0,o.kt)("inlineCode",{parentName:"p"},"method"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"path"),", and ",(0,o.kt)("inlineCode",{parentName:"p"},"version")," fields under ",(0,o.kt)("inlineCode",{parentName:"p"},"request"),".  To prepare for this, create a table including those nested fields:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE TABLE http\n(\n    `@timestamp` DateTime,\n    `clientip` IPv4,\n# highlight-next-line\n    `request` Tuple(method LowCardinality(String), path String, version LowCardinality(String)),\n    `status` UInt16,\n    `size` UInt32\n)\nENGINE = MergeTree\nORDER BY (status, `@timestamp`)\n")),(0,o.kt)("h3",{id:"describe-the-table-and-note-the-request-column"},"Describe the table and note the ",(0,o.kt)("inlineCode",{parentName:"h3"},"request")," column"),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"request")," field from the JSON file will be stored as a tuple."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"DESCRIBE TABLE http\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-response"},"\u250c\u2500name\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500type\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500default_type\u2500\u252c\u2500default_expression\u2500\u252c\u2500comment\u2500\u252c\u2500codec_expression\u2500\u252c\u2500ttl_expression\u2500\u2510\n\u2502 @timestamp \u2502 DateTime                                                                          \u2502              \u2502                    \u2502         \u2502                  \u2502                \u2502\n\u2502 clientip   \u2502 IPv4                                                                              \u2502              \u2502                    \u2502         \u2502                  \u2502                \u2502\n# highlight-next-line\n\u2502 request    \u2502 Tuple(method LowCardinality(String), path String, version LowCardinality(String)) \u2502              \u2502                    \u2502         \u2502                  \u2502                \u2502\n\u2502 status     \u2502 UInt16                                                                            \u2502              \u2502                    \u2502         \u2502                  \u2502                \u2502\n\u2502 size       \u2502 UInt32                                                                            \u2502              \u2502                    \u2502         \u2502                  \u2502                \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n")),(0,o.kt)("h2",{id:"insert-one-row"},"Insert one row"),(0,o.kt)("p",null,"When the response is inserted, all three components of the request are inserted."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"INSERT INTO http SELECT *\nFROM s3('https://datasets-documentation.s3.eu-west-3.amazonaws.com/http/documents-01.ndjson.gz', 'JSONEachRow')\nLIMIT 1\n")),(0,o.kt)("h2",{id:"verify"},"Verify"),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"method"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"path"),", and ",(0,o.kt)("inlineCode",{parentName:"p"},"version")," should be available to query individually."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\n    request.method,\n    request.path,\n    request.version\nFROM http\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-response"},"\u250c\u2500request.method\u2500\u252c\u2500request.path\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500request.version\u2500\u2510\n\u2502 GET            \u2502 /images/hm_bg.jpg \u2502 HTTP/1.0        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n")),(0,o.kt)("h2",{id:"insert-the-dataset"},"Insert the dataset"),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"The full dataset is 10 million rows, you can use ",(0,o.kt)("inlineCode",{parentName:"p"},"LIMIT")," to reduce\nthe number of rows inserted.  The query shown inserts 1 million rows.")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"INSERT INTO http SELECT *\nFROM s3('https://datasets-documentation.s3.eu-west-3.amazonaws.com/http/documents-01.ndjson.gz', 'JSONEachRow')\nLIMIT 1000000;\n")),(0,o.kt)("h2",{id:"query-the-data"},"Query the data"),(0,o.kt)("p",null,"This query gives a count of the queries between January 1st and June 1st grouped by the method and status."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\n    status,\n# highlight-next-line\n    request.method AS method,\n    count() AS c\nFROM http\nWHERE (status >= 400) AND ((`@timestamp` >= '1998-01-01 00:00:00') AND (`@timestamp` <= '1998-06-01 00:00:00'))\nGROUP BY\n    method,\n    status\nORDER BY c DESC\nLIMIT 5\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-response"},"\u250c\u2500status\u2500\u252c\u2500method\u2500\u2500\u252c\u2500\u2500\u2500\u2500c\u2500\u2510\n\u2502    404 \u2502 GET     \u2502 1161 \u2502\n\u2502    500 \u2502 POST    \u2502   14 \u2502\n\u2502    400 \u2502 GET     \u2502   13 \u2502\n\u2502    404 \u2502 OPTIONS \u2502   12 \u2502\n\u2502    500 \u2502 GET     \u2502    6 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n")),(0,o.kt)("h2",{id:"more-information"},"More information"),(0,o.kt)("h3",{id:"limitations-and-other-approaches"},"Limitations and other approaches"),(0,o.kt)("p",null,"If any of the fields in the tuple (",(0,o.kt)("inlineCode",{parentName:"p"},"request."),": ",(0,o.kt)("inlineCode",{parentName:"p"},"method"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"path"),", and ",(0,o.kt)("inlineCode",{parentName:"p"},"version"),") need to be included in the ORDER BY or PRIMARY KEY of the table, then the entire tuple must be added to the ORDER BY or PRIMARY Key.  For more information on the pros and cons of this method and other methods of loading JSON see ",(0,o.kt)("a",{parentName:"p",href:"/docs/en/guides/developer/working-with-json/json-other-approaches"},"JSON other approaches"),"."),(0,o.kt)("h3",{id:"json-input-and-output-formats"},"JSON input and output formats"),(0,o.kt)("p",null,"  The format ",(0,o.kt)("inlineCode",{parentName:"p"},"JSONEachRow")," is used in this guide, but there are other options, see the ",(0,o.kt)("a",{parentName:"p",href:"/docs/en/interfaces/formats/#json"},"input and output format docs"),"."))}c.isMDXComponent=!0}}]);