"use strict";(self.webpackChunkclickhouse_docs_2_3_0=self.webpackChunkclickhouse_docs_2_3_0||[]).push([[7258],{3905:(e,t,a)=>{a.d(t,{Zo:()=>d,kt:()=>_});var n=a(67294);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function l(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function r(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?l(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},l=Object.keys(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):r(r({},t),e)),a},d=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},m="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},c=n.forwardRef((function(e,t){var a=e.components,i=e.mdxType,l=e.originalType,s=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),m=p(a),c=i,_=m["".concat(s,".").concat(c)]||m[c]||u[c]||l;return a?n.createElement(_,r(r({ref:t},d),{},{components:a})):n.createElement(_,r({ref:t},d))}));function _(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var l=a.length,r=new Array(l);r[0]=c;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o[m]="string"==typeof e?e:i,r[1]=o;for(var p=2;p<l;p++)r[p]=a[p];return n.createElement.apply(null,r)}return n.createElement.apply(null,a)}c.displayName="MDXCreateElement"},35670:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>r,default:()=>u,frontMatter:()=>l,metadata:()=>o,toc:()=>p});var n=a(87462),i=(a(67294),a(3905));const l={slug:"/en/getting-started/example-datasets/nypd_complaint_data",sidebar_label:"NYPD Complaint Data",description:"Ingest and query Tab Separated Value data in 5 steps",title:"NYPD Complaint Data"},r=void 0,o={unversionedId:"en/getting-started/example-datasets/nypd_complaint_data",id:"en/getting-started/example-datasets/nypd_complaint_data",title:"NYPD Complaint Data",description:"Ingest and query Tab Separated Value data in 5 steps",source:"@site/docs/en/getting-started/example-datasets/nypd_complaint_data.md",sourceDirName:"en/getting-started/example-datasets",slug:"/en/getting-started/example-datasets/nypd_complaint_data",permalink:"/AlgoliaDocsSelfCrawl/en/getting-started/example-datasets/nypd_complaint_data",draft:!1,editUrl:"https://github.com/ClickHouse/ClickHouse/tree/master/docs/en/getting-started/example-datasets/nypd_complaint_data.md",tags:[],version:"current",frontMatter:{slug:"/en/getting-started/example-datasets/nypd_complaint_data",sidebar_label:"NYPD Complaint Data",description:"Ingest and query Tab Separated Value data in 5 steps",title:"NYPD Complaint Data"},sidebar:"english",previous:{title:"Web Analytics Data",permalink:"/AlgoliaDocsSelfCrawl/en/getting-started/example-datasets/metrica"},next:{title:"OnTime Airline Flight Data",permalink:"/AlgoliaDocsSelfCrawl/en/getting-started/example-datasets/ontime"}},s={},p=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"A note about the commands described in this guide",id:"a-note-about-the-commands-described-in-this-guide",level:3},{value:"Familiarize yourself with the TSV file",id:"familiarize-yourself-with-the-tsv-file",level:2},{value:"Look at the fields in the source TSV file",id:"look-at-the-fields-in-the-source-tsv-file",level:3},{value:"Determine the proper schema",id:"determine-the-proper-schema",level:3},{value:"DateTime fields",id:"datetime-fields",level:3},{value:"Make a plan",id:"make-a-plan",level:2},{value:"Concatenate the date and time fields",id:"concatenate-the-date-and-time-fields",level:2},{value:"Convert the date and time String to a DateTime64 type",id:"convert-the-date-and-time-string-to-a-datetime64-type",level:2},{value:"Create a table",id:"create-a-table",level:2},{value:"Order By and Primary Key clauses",id:"order-by-and-primary-key-clauses",level:3},{value:"Finding the primary key of a table",id:"finding-the-primary-key-of-a-table",level:3},{value:"Preprocess and Import Data",id:"preprocess-import-data",level:2},{value:"<code>clickhouse-local</code> arguments used",id:"clickhouse-local-arguments-used",level:3},{value:"Validate the Data",id:"validate-data",level:2},{value:"Run Some Queries",id:"run-queries",level:2},{value:"Query 1. Compare the number of complaints by month",id:"query-1-compare-the-number-of-complaints-by-month",level:3},{value:"Query 2. Compare total number of complaints by Borough",id:"query-2-compare-total-number-of-complaints-by-borough",level:3},{value:"Next Steps",id:"next-steps",level:2}],d={toc:p},m="wrapper";function u(e){let{components:t,...a}=e;return(0,i.kt)(m,(0,n.Z)({},d,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"Tab separated value, or TSV, files are common and may include field headings as the first line of the file. ClickHouse can ingest TSVs, and also can query TSVs without ingesting the files.  This guide covers both of these cases. If you need to query or ingest CSV files, the same techniques work, simply substitute ",(0,i.kt)("inlineCode",{parentName:"p"},"TSV")," with ",(0,i.kt)("inlineCode",{parentName:"p"},"CSV")," in your format arguments."),(0,i.kt)("p",null,"While working through this guide you will:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Investigate"),": Query the structure and content of the TSV file."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Determine the target ClickHouse schema"),": Choose proper data types and map the existing data to those types."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Create a ClickHouse table"),"."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Preprocess and stream")," the data to ClickHouse."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Run some queries")," against ClickHouse.")),(0,i.kt)("p",null,'The dataset used in this guide comes from the NYC Open Data team, and contains data about "all valid felony, misdemeanor, and violation crimes reported to the New York City Police Department (NYPD)". At the time of writing, the data file is 166MB, but it is updated regularly.'),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Source"),": ",(0,i.kt)("a",{parentName:"p",href:"https://data.cityofnewyork.us/Public-Safety/NYPD-Complaint-Data-Current-Year-To-Date-/5uac-w243"},"data.cityofnewyork.us"),(0,i.kt)("br",{parentName:"p"}),"\n",(0,i.kt)("strong",{parentName:"p"},"Terms of use"),": ",(0,i.kt)("a",{parentName:"p",href:"https://www1.nyc.gov/home/terms-of-use.page"},"https://www1.nyc.gov/home/terms-of-use.page")),(0,i.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Download the dataset by visiting the ",(0,i.kt)("a",{parentName:"li",href:"https://data.cityofnewyork.us/Public-Safety/NYPD-Complaint-Data-Current-Year-To-Date-/5uac-w243"},"NYPD Complaint Data Current (Year To Date)")," page, clicking the Export button, and choosing ",(0,i.kt)("strong",{parentName:"li"},"TSV for Excel"),"."),(0,i.kt)("li",{parentName:"ul"},"Install ",(0,i.kt)("a",{parentName:"li",href:"/AlgoliaDocsSelfCrawl/en/install"},"ClickHouse server and client"),"."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"/AlgoliaDocsSelfCrawl/en/install#launch"},"Launch")," ClickHouse server, and connect with ",(0,i.kt)("inlineCode",{parentName:"li"},"clickhouse-client"))),(0,i.kt)("h3",{id:"a-note-about-the-commands-described-in-this-guide"},"A note about the commands described in this guide"),(0,i.kt)("p",null,"There are two types of commands in this guide:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Some of the commands are querying the TSV files, these are run at the command prompt."),(0,i.kt)("li",{parentName:"ul"},"The rest of the commands are querying ClickHouse, and these are run in the ",(0,i.kt)("inlineCode",{parentName:"li"},"clickhouse-client")," or Play UI.")),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"The examples in this guide assume that you have saved the TSV file to ",(0,i.kt)("inlineCode",{parentName:"p"},"${HOME}/NYPD_Complaint_Data_Current__Year_To_Date_.tsv"),", please adjust the commands if needed.")),(0,i.kt)("h2",{id:"familiarize-yourself-with-the-tsv-file"},"Familiarize yourself with the TSV file"),(0,i.kt)("p",null,"Before starting to work with the ClickHouse database familiarize yourself with the data. "),(0,i.kt)("h3",{id:"look-at-the-fields-in-the-source-tsv-file"},"Look at the fields in the source TSV file"),(0,i.kt)("p",null,"This is an example of a command to query a TSV file, but don't run it yet."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sh"},"clickhouse-local --query \\\n\"describe file('${HOME}/NYPD_Complaint_Data_Current__Year_To_Date_.tsv', 'TSVWithNames')\"\n")),(0,i.kt)("p",null,"Sample response"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-response"},"CMPLNT_NUM                  Nullable(Float64)                   \nADDR_PCT_CD                 Nullable(Float64)                   \nBORO_NM                     Nullable(String)                    \nCMPLNT_FR_DT                Nullable(String)                    \nCMPLNT_FR_TM                Nullable(String)                    \n")),(0,i.kt)("admonition",{type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"Most of the time the above command will let you know which fields in the input data are numeric, and which are strings, and which are tuples.  This is not always the case.  Because ClickHouse is routineley used with datasets containing billions of records there is a default number (100) of rows examined to ",(0,i.kt)("a",{parentName:"p",href:"/AlgoliaDocsSelfCrawl/en/guides/developer/working-with-json/json-semi-structured/#relying-on-schema-inference"},"infer the schema")," in order to avoid parsing billions of rows to infer the schema. The response below may not match what you see, as the dataset is updated several times each year. Looking at the Data Dictionary you can see that CMPLNT_NUM is specified as text, and not numeric.  By overriding the default of 100 rows for inference with the setting ",(0,i.kt)("inlineCode",{parentName:"p"},"SETTINGS input_format_max_rows_to_read_for_schema_inference=2000"),"\nyou can get a better idea of the content."),(0,i.kt)("p",{parentName:"admonition"},"Note: as of version 22.5 the default is now 25,000 rows for inferring the schema, so only change the setting if you are on an older version or if you need more than 25,000 rows to be sampled.")),(0,i.kt)("p",null,"Run this command at your command prompt.  You will be using ",(0,i.kt)("inlineCode",{parentName:"p"},"clickhouse-local")," to query the data in the TSV file you downloaded."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sh"},"clickhouse-local --input_format_max_rows_to_read_for_schema_inference=2000 \\\n--query \\\n\"describe file('${HOME}/NYPD_Complaint_Data_Current__Year_To_Date_.tsv', 'TSVWithNames')\" \n")),(0,i.kt)("p",null,"Result:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-response"},"CMPLNT_NUM        Nullable(String)                  \nADDR_PCT_CD       Nullable(Float64)                 \nBORO_NM           Nullable(String)                  \nCMPLNT_FR_DT      Nullable(String)                  \nCMPLNT_FR_TM      Nullable(String)                  \nCMPLNT_TO_DT      Nullable(String)                  \nCMPLNT_TO_TM      Nullable(String)                  \nCRM_ATPT_CPTD_CD  Nullable(String)                  \nHADEVELOPT        Nullable(String)                  \nHOUSING_PSA       Nullable(Float64)                 \nJURISDICTION_CODE Nullable(Float64)                 \nJURIS_DESC        Nullable(String)                  \nKY_CD             Nullable(Float64)                 \nLAW_CAT_CD        Nullable(String)                  \nLOC_OF_OCCUR_DESC Nullable(String)                  \nOFNS_DESC         Nullable(String)                  \nPARKS_NM          Nullable(String)                  \nPATROL_BORO       Nullable(String)                  \nPD_CD             Nullable(Float64)                 \nPD_DESC           Nullable(String)                  \nPREM_TYP_DESC     Nullable(String)                  \nRPT_DT            Nullable(String)                  \nSTATION_NAME      Nullable(String)                  \nSUSP_AGE_GROUP    Nullable(String)                  \nSUSP_RACE         Nullable(String)                  \nSUSP_SEX          Nullable(String)                  \nTRANSIT_DISTRICT  Nullable(Float64)                 \nVIC_AGE_GROUP     Nullable(String)                  \nVIC_RACE          Nullable(String)                  \nVIC_SEX           Nullable(String)                  \nX_COORD_CD        Nullable(Float64)                 \nY_COORD_CD        Nullable(Float64)                 \nLatitude          Nullable(Float64)                 \nLongitude         Nullable(Float64)                 \nLat_Lon           Tuple(Nullable(Float64), Nullable(Float64))                   \nNew Georeferenced Column Nullable(String)\n")),(0,i.kt)("p",null,"At this point you should check that the columns in the TSV file match the names and types specified in the ",(0,i.kt)("strong",{parentName:"p"},"Columns in this Dataset")," section of the ",(0,i.kt)("a",{parentName:"p",href:"https://data.cityofnewyork.us/Public-Safety/NYPD-Complaint-Data-Current-Year-To-Date-/5uac-w243"},"dataset web page"),".  The data types are not very specific, all numeric fields are set to ",(0,i.kt)("inlineCode",{parentName:"p"},"Nullable(Float64)"),", and all other fields are ",(0,i.kt)("inlineCode",{parentName:"p"},"Nullable(String)"),".  When you create a ClickHouse table to store the data you can specify more appropriate and performant types."),(0,i.kt)("h3",{id:"determine-the-proper-schema"},"Determine the proper schema"),(0,i.kt)("p",null,"In order to figure out what types should be used for the fields it is necessary to know what the data looks like. For example, the field ",(0,i.kt)("inlineCode",{parentName:"p"},"JURISDICTION_CODE")," is a numeric: should it be a ",(0,i.kt)("inlineCode",{parentName:"p"},"UInt8"),", or an ",(0,i.kt)("inlineCode",{parentName:"p"},"Enum"),", or is ",(0,i.kt)("inlineCode",{parentName:"p"},"Float64")," appropriate?"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"clickhouse-local --input_format_max_rows_to_read_for_schema_inference=2000 \\\n--query \\\n\"select JURISDICTION_CODE, count() FROM\n file('${HOME}/NYPD_Complaint_Data_Current__Year_To_Date_.tsv', 'TSVWithNames')\n GROUP BY JURISDICTION_CODE\n ORDER BY JURISDICTION_CODE\n FORMAT PrettyCompact\"\n")),(0,i.kt)("p",null,"Result:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-response"},"\u250c\u2500JURISDICTION_CODE\u2500\u252c\u2500count()\u2500\u2510\n\u2502                 0 \u2502  188875 \u2502\n\u2502                 1 \u2502    4799 \u2502\n\u2502                 2 \u2502   13833 \u2502\n\u2502                 3 \u2502     656 \u2502\n\u2502                 4 \u2502      51 \u2502\n\u2502                 6 \u2502       5 \u2502\n\u2502                 7 \u2502       2 \u2502\n\u2502                 9 \u2502      13 \u2502\n\u2502                11 \u2502      14 \u2502\n\u2502                12 \u2502       5 \u2502\n\u2502                13 \u2502       2 \u2502\n\u2502                14 \u2502      70 \u2502\n\u2502                15 \u2502      20 \u2502\n\u2502                72 \u2502     159 \u2502\n\u2502                87 \u2502       9 \u2502\n\u2502                88 \u2502      75 \u2502\n\u2502                97 \u2502     405 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n")),(0,i.kt)("p",null,"The query response shows that the ",(0,i.kt)("inlineCode",{parentName:"p"},"JURISDICTION_CODE")," fits well in a ",(0,i.kt)("inlineCode",{parentName:"p"},"UInt8"),"."),(0,i.kt)("p",null,"Similarly, look at some of the ",(0,i.kt)("inlineCode",{parentName:"p"},"String")," fields and see if they are well suited to being ",(0,i.kt)("inlineCode",{parentName:"p"},"DateTime")," or ",(0,i.kt)("a",{parentName:"p",href:"../../sql-reference/data-types/lowcardinality.md"},(0,i.kt)("inlineCode",{parentName:"a"},"LowCardinality(String)"))," fields."),(0,i.kt)("p",null,"For example, the field ",(0,i.kt)("inlineCode",{parentName:"p"},"PARKS_NM"),' is described as "Name of NYC park, playground or greenspace of occurrence, if applicable (state parks are not included)".  The names of parks in New York City may be a good candidate for a ',(0,i.kt)("inlineCode",{parentName:"p"},"LowCardinality(String)"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sh"},"clickhouse-local --input_format_max_rows_to_read_for_schema_inference=2000 \\\n--query \\\n\"select count(distinct PARKS_NM) FROM\n file('${HOME}/NYPD_Complaint_Data_Current__Year_To_Date_.tsv', 'TSVWithNames')\n FORMAT PrettyCompact\"\n")),(0,i.kt)("p",null,"Result:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-response"},"\u250c\u2500uniqExact(PARKS_NM)\u2500\u2510\n\u2502                 319 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n")),(0,i.kt)("p",null,"Have a look at some of the park names:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"clickhouse-local --input_format_max_rows_to_read_for_schema_inference=2000 \\\n--query \\\n\"select distinct PARKS_NM FROM\n file('${HOME}/NYPD_Complaint_Data_Current__Year_To_Date_.tsv', 'TSVWithNames')\n LIMIT 10\n FORMAT PrettyCompact\"\n")),(0,i.kt)("p",null,"Result:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-response"},"\u250c\u2500PARKS_NM\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 (null)                     \u2502\n\u2502 ASSER LEVY PARK            \u2502\n\u2502 JAMES J WALKER PARK        \u2502\n\u2502 BELT PARKWAY/SHORE PARKWAY \u2502\n\u2502 PROSPECT PARK              \u2502\n\u2502 MONTEFIORE SQUARE          \u2502\n\u2502 SUTTON PLACE PARK          \u2502\n\u2502 JOYCE KILMER PARK          \u2502\n\u2502 ALLEY ATHLETIC PLAYGROUND  \u2502\n\u2502 ASTORIA PARK               \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n")),(0,i.kt)("p",null,"The dataset in use at the time of writing has only a few hundred distinct parks and playgrounds in the ",(0,i.kt)("inlineCode",{parentName:"p"},"PARK_NM")," column.  This is a small number based on the ",(0,i.kt)("a",{parentName:"p",href:"../../sql-reference/data-types/lowcardinality.md#lowcardinality-dscr"},"LowCardinality")," recommendation to stay below 10,000 distinct strings in a ",(0,i.kt)("inlineCode",{parentName:"p"},"LowCardinality(String)")," field."),(0,i.kt)("h3",{id:"datetime-fields"},"DateTime fields"),(0,i.kt)("p",null,"Based on the ",(0,i.kt)("strong",{parentName:"p"},"Columns in this Dataset")," section of the ",(0,i.kt)("a",{parentName:"p",href:"https://data.cityofnewyork.us/Public-Safety/NYPD-Complaint-Data-Current-Year-To-Date-/5uac-w243"},"dataset web page")," there are date and time fields for the start and end of the reported event.  Looking at the min and max of the ",(0,i.kt)("inlineCode",{parentName:"p"},"CMPLNT_FR_DT")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"CMPLT_TO_DT")," gives an idea of whether or not the fields are always populated:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sh",metastring:'title="CMPLNT_FR_DT"',title:'"CMPLNT_FR_DT"'},"clickhouse-local --input_format_max_rows_to_read_for_schema_inference=2000 \\\n--query \\\n\"select min(CMPLNT_FR_DT), max(CMPLNT_FR_DT) FROM\nfile('${HOME}/NYPD_Complaint_Data_Current__Year_To_Date_.tsv', 'TSVWithNames')\nFORMAT PrettyCompact\"\n")),(0,i.kt)("p",null,"Result:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-response"},"\u250c\u2500min(CMPLNT_FR_DT)\u2500\u252c\u2500max(CMPLNT_FR_DT)\u2500\u2510\n\u2502 01/01/1973        \u2502 12/31/2021        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sh",metastring:'title="CMPLNT_TO_DT"',title:'"CMPLNT_TO_DT"'},"clickhouse-local --input_format_max_rows_to_read_for_schema_inference=2000 \\\n--query \\\n\"select min(CMPLNT_TO_DT), max(CMPLNT_TO_DT) FROM\nfile('${HOME}/NYPD_Complaint_Data_Current__Year_To_Date_.tsv', 'TSVWithNames')\nFORMAT PrettyCompact\"\n")),(0,i.kt)("p",null,"Result:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-response"},"\u250c\u2500min(CMPLNT_TO_DT)\u2500\u252c\u2500max(CMPLNT_TO_DT)\u2500\u2510\n\u2502                   \u2502 12/31/2021        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sh",metastring:'title="CMPLNT_FR_TM"',title:'"CMPLNT_FR_TM"'},"clickhouse-local --input_format_max_rows_to_read_for_schema_inference=2000 \\\n--query \\\n\"select min(CMPLNT_FR_TM), max(CMPLNT_FR_TM) FROM\nfile('${HOME}/NYPD_Complaint_Data_Current__Year_To_Date_.tsv', 'TSVWithNames')\nFORMAT PrettyCompact\"\n")),(0,i.kt)("p",null,"Result:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-response"},"\u250c\u2500min(CMPLNT_FR_TM)\u2500\u252c\u2500max(CMPLNT_FR_TM)\u2500\u2510\n\u2502 00:00:00          \u2502 23:59:00          \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sh",metastring:'title="CMPLNT_TO_TM"',title:'"CMPLNT_TO_TM"'},"clickhouse-local --input_format_max_rows_to_read_for_schema_inference=2000 \\\n--query \\\n\"select min(CMPLNT_TO_TM), max(CMPLNT_TO_TM) FROM\nfile('${HOME}/NYPD_Complaint_Data_Current__Year_To_Date_.tsv', 'TSVWithNames')\nFORMAT PrettyCompact\"\n")),(0,i.kt)("p",null,"Result:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-response"},"\u250c\u2500min(CMPLNT_TO_TM)\u2500\u252c\u2500max(CMPLNT_TO_TM)\u2500\u2510\n\u2502 (null)            \u2502 23:59:00          \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n")),(0,i.kt)("h2",{id:"make-a-plan"},"Make a plan"),(0,i.kt)("p",null,"Based on the above investigation:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"JURISDICTION_CODE")," should be cast as ",(0,i.kt)("inlineCode",{parentName:"li"},"UInt8"),"."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"PARKS_NM")," should be cast to ",(0,i.kt)("inlineCode",{parentName:"li"},"LowCardinality(String)")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"CMPLNT_FR_DT")," and ",(0,i.kt)("inlineCode",{parentName:"li"},"CMPLNT_FR_TM")," are always populated (possibly with a default time of ",(0,i.kt)("inlineCode",{parentName:"li"},"00:00:00"),")"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"CMPLNT_TO_DT")," and ",(0,i.kt)("inlineCode",{parentName:"li"},"CMPLNT_TO_TM")," may be empty"),(0,i.kt)("li",{parentName:"ul"},"Dates and times are stored in separate fields in the source"),(0,i.kt)("li",{parentName:"ul"},"Dates are ",(0,i.kt)("inlineCode",{parentName:"li"},"mm/dd/yyyy")," format"),(0,i.kt)("li",{parentName:"ul"},"Times are ",(0,i.kt)("inlineCode",{parentName:"li"},"hh:mm:ss")," format"),(0,i.kt)("li",{parentName:"ul"},"Dates and times can be concatenated into DateTime types"),(0,i.kt)("li",{parentName:"ul"},"There are some dates before January 1st 1970, which means we need a 64 bit DateTime")),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"There are many more changes to be made to the types, they all can be determined by following the same investigation steps.  Look at the number of distinct strings in a field, the min and max of the numerics, and make your decisions.  The table schema that is given later in the guide has many low cardinality strings and unsigned integer fields and very few floating point numerics.")),(0,i.kt)("h2",{id:"concatenate-the-date-and-time-fields"},"Concatenate the date and time fields"),(0,i.kt)("p",null,"To concatenate the date and time fields ",(0,i.kt)("inlineCode",{parentName:"p"},"CMPLNT_FR_DT")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"CMPLNT_FR_TM")," into a single ",(0,i.kt)("inlineCode",{parentName:"p"},"String")," that can be cast to a ",(0,i.kt)("inlineCode",{parentName:"p"},"DateTime"),", select the two fields joined by the concatenation operator: ",(0,i.kt)("inlineCode",{parentName:"p"},"CMPLNT_FR_DT || ' ' || CMPLNT_FR_TM"),".  The ",(0,i.kt)("inlineCode",{parentName:"p"},"CMPLNT_TO_DT")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"CMPLNT_TO_TM")," fields are handled similarly."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sh"},"clickhouse-local --input_format_max_rows_to_read_for_schema_inference=2000 \\\n--query \\\n\"select CMPLNT_FR_DT || ' ' || CMPLNT_FR_TM AS complaint_begin FROM\nfile('${HOME}/NYPD_Complaint_Data_Current__Year_To_Date_.tsv', 'TSVWithNames')\nLIMIT 10\nFORMAT PrettyCompact\"\n")),(0,i.kt)("p",null,"Result:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-response"},"\u250c\u2500complaint_begin\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 07/29/2010 00:01:00 \u2502\n\u2502 12/01/2011 12:00:00 \u2502\n\u2502 04/01/2017 15:00:00 \u2502\n\u2502 03/26/2018 17:20:00 \u2502\n\u2502 01/01/2019 00:00:00 \u2502\n\u2502 06/14/2019 00:00:00 \u2502\n\u2502 11/29/2021 20:00:00 \u2502\n\u2502 12/04/2021 00:35:00 \u2502\n\u2502 12/05/2021 12:50:00 \u2502\n\u2502 12/07/2021 20:30:00 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n")),(0,i.kt)("h2",{id:"convert-the-date-and-time-string-to-a-datetime64-type"},"Convert the date and time String to a DateTime64 type"),(0,i.kt)("p",null,"Earlier in the guide we discovered that there are dates in the TSV file before January 1st 1970, which means that we need a 64 bit DateTime type for the dates.  The dates also need to be converted from ",(0,i.kt)("inlineCode",{parentName:"p"},"MM/DD/YYYY")," to ",(0,i.kt)("inlineCode",{parentName:"p"},"YYYY/MM/DD")," format.  Both of these can be done with ",(0,i.kt)("a",{parentName:"p",href:"../../sql-reference/functions/type-conversion-functions.md#parsedatetime64besteffort"},(0,i.kt)("inlineCode",{parentName:"a"},"parseDateTime64BestEffort()")),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sh"},"clickhouse-local --input_format_max_rows_to_read_for_schema_inference=2000 \\\n--query \\\n\"WITH (CMPLNT_FR_DT || ' ' || CMPLNT_FR_TM) AS CMPLNT_START,\n      (CMPLNT_TO_DT || ' ' || CMPLNT_TO_TM) AS CMPLNT_END\nselect parseDateTime64BestEffort(CMPLNT_START) AS complaint_begin,\n       parseDateTime64BestEffortOrNull(CMPLNT_END) AS complaint_end\nFROM file('${HOME}/NYPD_Complaint_Data_Current__Year_To_Date_.tsv', 'TSVWithNames')\nORDER BY complaint_begin ASC\nLIMIT 25\nFORMAT PrettyCompact\"\n")),(0,i.kt)("p",null,"Lines 2 and 3 above contain the concatenation from the previous step, and lines 4 and 5 above parse the strings into ",(0,i.kt)("inlineCode",{parentName:"p"},"DateTime64"),".  As the complaint end time is not guaranteed to exist ",(0,i.kt)("inlineCode",{parentName:"p"},"parseDateTime64BestEffortOrNull")," is used."),(0,i.kt)("p",null,"Result:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-response"},"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500complaint_begin\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500complaint_end\u2500\u2510\n\u2502 1925-01-01 10:00:00.000 \u2502 2021-02-12 09:30:00.000 \u2502\n\u2502 1925-01-01 11:37:00.000 \u2502 2022-01-16 11:49:00.000 \u2502\n\u2502 1925-01-01 15:00:00.000 \u2502 2021-12-31 00:00:00.000 \u2502\n\u2502 1925-01-01 15:00:00.000 \u2502 2022-02-02 22:00:00.000 \u2502\n\u2502 1925-01-01 19:00:00.000 \u2502 2022-04-14 05:00:00.000 \u2502\n\u2502 1955-09-01 19:55:00.000 \u2502 2022-08-01 00:45:00.000 \u2502\n\u2502 1972-03-17 11:40:00.000 \u2502 2022-03-17 11:43:00.000 \u2502\n\u2502 1972-05-23 22:00:00.000 \u2502 2022-05-24 09:00:00.000 \u2502\n\u2502 1972-05-30 23:37:00.000 \u2502 2022-05-30 23:50:00.000 \u2502\n\u2502 1972-07-04 02:17:00.000 \u2502                    \u1d3a\u1d41\u1d38\u1d38 \u2502\n\u2502 1973-01-01 00:00:00.000 \u2502                    \u1d3a\u1d41\u1d38\u1d38 \u2502\n\u2502 1975-01-01 00:00:00.000 \u2502                    \u1d3a\u1d41\u1d38\u1d38 \u2502\n\u2502 1976-11-05 00:01:00.000 \u2502 1988-10-05 23:59:00.000 \u2502\n\u2502 1977-01-01 00:00:00.000 \u2502 1977-01-01 23:59:00.000 \u2502\n\u2502 1977-12-20 00:01:00.000 \u2502                    \u1d3a\u1d41\u1d38\u1d38 \u2502\n\u2502 1981-01-01 00:01:00.000 \u2502                    \u1d3a\u1d41\u1d38\u1d38 \u2502\n\u2502 1981-08-14 00:00:00.000 \u2502 1987-08-13 23:59:00.000 \u2502\n\u2502 1983-01-07 00:00:00.000 \u2502 1990-01-06 00:00:00.000 \u2502\n\u2502 1984-01-01 00:01:00.000 \u2502 1984-12-31 23:59:00.000 \u2502\n\u2502 1985-01-01 12:00:00.000 \u2502 1987-12-31 15:00:00.000 \u2502\n\u2502 1985-01-11 09:00:00.000 \u2502 1985-12-31 12:00:00.000 \u2502\n\u2502 1986-03-16 00:05:00.000 \u2502 2022-03-16 00:45:00.000 \u2502\n\u2502 1987-01-07 00:00:00.000 \u2502 1987-01-09 00:00:00.000 \u2502\n\u2502 1988-04-03 18:30:00.000 \u2502 2022-08-03 09:45:00.000 \u2502\n\u2502 1988-07-29 12:00:00.000 \u2502 1990-07-27 22:00:00.000 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n")),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"The dates shown as ",(0,i.kt)("inlineCode",{parentName:"p"},"1925")," above are from errors in the data.  There are several records in the original data with dates in the years ",(0,i.kt)("inlineCode",{parentName:"p"},"1019")," - ",(0,i.kt)("inlineCode",{parentName:"p"},"1022")," that should be ",(0,i.kt)("inlineCode",{parentName:"p"},"2019")," - ",(0,i.kt)("inlineCode",{parentName:"p"},"2022"),".  They are being stored as Jan 1st 1925 as that is the earliest date with a 64 bit DateTime.")),(0,i.kt)("h2",{id:"create-a-table"},"Create a table"),(0,i.kt)("p",null,"The decisions made above on the data types used for the columns are reflected in the table schema\nbelow. We also need to decide on the ",(0,i.kt)("inlineCode",{parentName:"p"},"ORDER BY")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"PRIMARY KEY")," used for the table.  At least one\nof ",(0,i.kt)("inlineCode",{parentName:"p"},"ORDER BY")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"PRIMARY KEY")," must be specified.  Here are some guidelines on deciding on the\ncolumns to includes in ",(0,i.kt)("inlineCode",{parentName:"p"},"ORDER BY"),", and more information is in the ",(0,i.kt)("em",{parentName:"p"},"Next Steps")," section at the end\nof this document."),(0,i.kt)("h3",{id:"order-by-and-primary-key-clauses"},"Order By and Primary Key clauses"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"The ",(0,i.kt)("inlineCode",{parentName:"li"},"ORDER BY")," tuple should include fields that are used in query filters"),(0,i.kt)("li",{parentName:"ul"},"To maximize compression on disk the ",(0,i.kt)("inlineCode",{parentName:"li"},"ORDER BY")," tuple should be ordered by ascending cardinality"),(0,i.kt)("li",{parentName:"ul"},"If it exists, the ",(0,i.kt)("inlineCode",{parentName:"li"},"PRIMARY KEY")," tuple must be a subset of the ",(0,i.kt)("inlineCode",{parentName:"li"},"ORDER BY")," tuple"),(0,i.kt)("li",{parentName:"ul"},"If only ",(0,i.kt)("inlineCode",{parentName:"li"},"ORDER BY")," is specified, then the same tuple will be used as ",(0,i.kt)("inlineCode",{parentName:"li"},"PRIMARY KEY")),(0,i.kt)("li",{parentName:"ul"},"The primary key index is created using the ",(0,i.kt)("inlineCode",{parentName:"li"},"PRIMARY KEY")," tuple if specified, otherwise the ",(0,i.kt)("inlineCode",{parentName:"li"},"ORDER BY")," tuple"),(0,i.kt)("li",{parentName:"ul"},"The ",(0,i.kt)("inlineCode",{parentName:"li"},"PRIMARY KEY")," index is kept in main memory")),(0,i.kt)("p",null,"Looking at the dataset and the questions that might be answered by querying it we might\ndecide that we would look at the types of crimes reported over time in the five boroughs of\nNew York City.  These fields might be then included in the ",(0,i.kt)("inlineCode",{parentName:"p"},"ORDER BY"),":"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null},"Column"),(0,i.kt)("th",{parentName:"tr",align:null},"Description (from the data dictionary)"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"OFNS_DESC"),(0,i.kt)("td",{parentName:"tr",align:null},"Description of offense corresponding with key code")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"RPT_DT"),(0,i.kt)("td",{parentName:"tr",align:null},"Date event was reported to police")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"BORO_NM"),(0,i.kt)("td",{parentName:"tr",align:null},"The name of the borough in which the incident occurred")))),(0,i.kt)("p",null,"Querying the TSV file for the cardinality of the three candidate columns:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"clickhouse-local --input_format_max_rows_to_read_for_schema_inference=2000 \\\n--query \\\n\"select formatReadableQuantity(uniq(OFNS_DESC)) as cardinality_OFNS_DESC,\n        formatReadableQuantity(uniq(RPT_DT)) as cardinality_RPT_DT,\n        formatReadableQuantity(uniq(BORO_NM)) as cardinality_BORO_NM\n  FROM\n  file('${HOME}/NYPD_Complaint_Data_Current__Year_To_Date_.tsv', 'TSVWithNames')\n  FORMAT PrettyCompact\"\n")),(0,i.kt)("p",null,"Result:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-response"},"\u250c\u2500cardinality_OFNS_DESC\u2500\u252c\u2500cardinality_RPT_DT\u2500\u252c\u2500cardinality_BORO_NM\u2500\u2510\n\u2502 60.00                 \u2502 306.00             \u2502 6.00                \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n")),(0,i.kt)("p",null,"Ordering by cardinality, the ",(0,i.kt)("inlineCode",{parentName:"p"},"ORDER BY")," becomes:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"ORDER BY ( BORO_NM, OFNS_DESC, RPT_DT )\n")),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"The table below will use more easily read column names, the above names will be mapped to"),(0,i.kt)("pre",{parentName:"admonition"},(0,i.kt)("code",{parentName:"pre"},"ORDER BY ( borough, offense_description, date_reported )\n"))),(0,i.kt)("p",null,"Putting together the changes to data types and the ",(0,i.kt)("inlineCode",{parentName:"p"},"ORDER BY")," tuple gives this table structure:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE TABLE NYPD_Complaint ( \n    complaint_number     String,\n    precinct             UInt8,\n    borough              LowCardinality(String),\n    complaint_begin      DateTime64(0,'America/New_York'),\n    complaint_end        DateTime64(0,'America/New_York'),\n    was_crime_completed  String,\n    housing_authority    String,\n    housing_level_code   UInt32,\n    jurisdiction_code    UInt8, \n    jurisdiction         LowCardinality(String),\n    offense_code         UInt8,\n    offense_level        LowCardinality(String),\n    location_descriptor  LowCardinality(String),\n    offense_description  LowCardinality(String),\n    park_name            LowCardinality(String),\n    patrol_borough       LowCardinality(String),\n    PD_CD                UInt16,\n    PD_DESC              String,\n    location_type        LowCardinality(String),\n    date_reported        Date,\n    transit_station      LowCardinality(String),\n    suspect_age_group    LowCardinality(String),\n    suspect_race         LowCardinality(String),\n    suspect_sex          LowCardinality(String),\n    transit_district     UInt8,\n    victim_age_group     LowCardinality(String),\n    victim_race          LowCardinality(String),\n    victim_sex           LowCardinality(String),\n    NY_x_coordinate      UInt32,\n    NY_y_coordinate      UInt32,\n    Latitude             Float64,\n    Longitude            Float64\n) ENGINE = MergeTree\n  ORDER BY ( borough, offense_description, date_reported )\n")),(0,i.kt)("h3",{id:"finding-the-primary-key-of-a-table"},"Finding the primary key of a table"),(0,i.kt)("p",null,"The ClickHouse ",(0,i.kt)("inlineCode",{parentName:"p"},"system")," database, specifically ",(0,i.kt)("inlineCode",{parentName:"p"},"system.table")," has all of the information about the table you\njust created.  This query shows the ",(0,i.kt)("inlineCode",{parentName:"p"},"ORDER BY")," (sorting key), and the ",(0,i.kt)("inlineCode",{parentName:"p"},"PRIMARY KEY"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\n    partition_key,\n    sorting_key,\n    primary_key,\n    table\nFROM system.tables\nWHERE table = 'NYPD_Complaint'\nFORMAT Vertical\n")),(0,i.kt)("p",null,"Response"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-response"},"Query id: 6a5b10bf-9333-4090-b36e-c7f08b1d9e01\n\nRow 1:\n\u2500\u2500\u2500\u2500\u2500\u2500\npartition_key: \nsorting_key:   borough, offense_description, date_reported\nprimary_key:   borough, offense_description, date_reported\ntable:         NYPD_Complaint\n\n1 row in set. Elapsed: 0.001 sec.\n")),(0,i.kt)("h2",{id:"preprocess-import-data"},"Preprocess and Import Data"),(0,i.kt)("p",null,"We will use ",(0,i.kt)("inlineCode",{parentName:"p"},"clickhouse-local")," tool for data preprocessing and ",(0,i.kt)("inlineCode",{parentName:"p"},"clickhouse-client")," to upload it."),(0,i.kt)("h3",{id:"clickhouse-local-arguments-used"},(0,i.kt)("inlineCode",{parentName:"h3"},"clickhouse-local")," arguments used"),(0,i.kt)("admonition",{type:"tip"},(0,i.kt)("p",{parentName:"admonition"},(0,i.kt)("inlineCode",{parentName:"p"},"table='input'")," appears in the arguments to clickhouse-local below.  clickhouse-local takes the provided input (",(0,i.kt)("inlineCode",{parentName:"p"},"cat ${HOME}/NYPD_Complaint_Data_Current__Year_To_Date_.tsv"),") and inserts the input into a table.  By default the table is named ",(0,i.kt)("inlineCode",{parentName:"p"},"table"),".  In this guide the name of the table is set to ",(0,i.kt)("inlineCode",{parentName:"p"},"input")," to make the data flow clearer. The final argument to clickhouse-local is a query that selects from the table (",(0,i.kt)("inlineCode",{parentName:"p"},"FROM input"),") which is then piped to ",(0,i.kt)("inlineCode",{parentName:"p"},"clickhouse-client")," to populate the table ",(0,i.kt)("inlineCode",{parentName:"p"},"NYPD_Complaint"),".")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"cat ${HOME}/NYPD_Complaint_Data_Current__Year_To_Date_.tsv \\\n  | clickhouse-local --table='input' --input-format='TSVWithNames' \\\n  --input_format_max_rows_to_read_for_schema_inference=2000 \\\n  --query \"\n    WITH (CMPLNT_FR_DT || ' ' || CMPLNT_FR_TM) AS CMPLNT_START,\n     (CMPLNT_TO_DT || ' ' || CMPLNT_TO_TM) AS CMPLNT_END\n    SELECT\n      CMPLNT_NUM                                  AS complaint_number,\n      ADDR_PCT_CD                                 AS precinct,\n      BORO_NM                                     AS borough,\n      parseDateTime64BestEffort(CMPLNT_START)     AS complaint_begin,\n      parseDateTime64BestEffortOrNull(CMPLNT_END) AS complaint_end,\n      CRM_ATPT_CPTD_CD                            AS was_crime_completed,\n      HADEVELOPT                                  AS housing_authority_development,\n      HOUSING_PSA                                 AS housing_level_code,\n      JURISDICTION_CODE                           AS jurisdiction_code, \n      JURIS_DESC                                  AS jurisdiction,\n      KY_CD                                       AS offense_code,\n      LAW_CAT_CD                                  AS offense_level,\n      LOC_OF_OCCUR_DESC                           AS location_descriptor,\n      OFNS_DESC                                   AS offense_description, \n      PARKS_NM                                    AS park_name,\n      PATROL_BORO                                 AS patrol_borough,\n      PD_CD,\n      PD_DESC,\n      PREM_TYP_DESC                               AS location_type,\n      toDate(parseDateTimeBestEffort(RPT_DT))     AS date_reported,\n      STATION_NAME                                AS transit_station,\n      SUSP_AGE_GROUP                              AS suspect_age_group,\n      SUSP_RACE                                   AS suspect_race,\n      SUSP_SEX                                    AS suspect_sex,\n      TRANSIT_DISTRICT                            AS transit_district,\n      VIC_AGE_GROUP                               AS victim_age_group,   \n      VIC_RACE                                    AS victim_race,\n      VIC_SEX                                     AS victim_sex,\n      X_COORD_CD                                  AS NY_x_coordinate,\n      Y_COORD_CD                                  AS NY_y_coordinate,\n      Latitude,\n      Longitude\n    FROM input\" \\\n  | clickhouse-client --query='INSERT INTO NYPD_Complaint FORMAT TSV'\n")),(0,i.kt)("h2",{id:"validate-data"},"Validate the Data"),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"The dataset changes once or more per year, your counts may not match what is in this document.")),(0,i.kt)("p",null,"Query:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT count()\nFROM NYPD_Complaint\n")),(0,i.kt)("p",null,"Result:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-text"},"\u250c\u2500count()\u2500\u2510\n\u2502  208993 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n1 row in set. Elapsed: 0.001 sec. \n")),(0,i.kt)("p",null,"The size of the dataset in ClickHouse is just 12% of the original TSV file, compare the size of the original TSV file with the size of the table:"),(0,i.kt)("p",null,"Query:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT formatReadableSize(total_bytes)\nFROM system.tables\nWHERE name = 'NYPD_Complaint'\n")),(0,i.kt)("p",null,"Result:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-text"},"\u250c\u2500formatReadableSize(total_bytes)\u2500\u2510\n\u2502 8.63 MiB                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n")),(0,i.kt)("h2",{id:"run-queries"},"Run Some Queries"),(0,i.kt)("h3",{id:"query-1-compare-the-number-of-complaints-by-month"},"Query 1. Compare the number of complaints by month"),(0,i.kt)("p",null,"Query:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\n    dateName('month', date_reported) AS month,\n    count() AS complaints,\n    bar(complaints, 0, 50000, 80)\nFROM NYPD_Complaint\nGROUP BY month\nORDER BY complaints DESC\n")),(0,i.kt)("p",null,"Result:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-response"},"Query id: 7fbd4244-b32a-4acf-b1f3-c3aa198e74d9\n\n\u250c\u2500month\u2500\u2500\u2500\u2500\u2500\u252c\u2500complaints\u2500\u252c\u2500bar(count(), 0, 50000, 80)\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 March     \u2502      34536 \u2502 \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258e \u2502\n\u2502 May       \u2502      34250 \u2502 \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258b  \u2502\n\u2502 April     \u2502      32541 \u2502 \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588     \u2502\n\u2502 January   \u2502      30806 \u2502 \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258e       \u2502\n\u2502 February  \u2502      28118 \u2502 \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258a            \u2502\n\u2502 November  \u2502       7474 \u2502 \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258a                                             \u2502\n\u2502 December  \u2502       7223 \u2502 \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258c                                             \u2502\n\u2502 October   \u2502       7070 \u2502 \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258e                                             \u2502\n\u2502 September \u2502       6910 \u2502 \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588                                              \u2502\n\u2502 August    \u2502       6801 \u2502 \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258a                                              \u2502\n\u2502 June      \u2502       6779 \u2502 \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258b                                              \u2502\n\u2502 July      \u2502       6485 \u2502 \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258d                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n12 rows in set. Elapsed: 0.006 sec. Processed 208.99 thousand rows, 417.99 KB (37.48 million rows/s., 74.96 MB/s.)\n")),(0,i.kt)("h3",{id:"query-2-compare-total-number-of-complaints-by-borough"},"Query 2. Compare total number of complaints by Borough"),(0,i.kt)("p",null,"Query:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\n    borough,\n    count() AS complaints,\n    bar(complaints, 0, 125000, 60)\nFROM NYPD_Complaint\nGROUP BY borough\nORDER BY complaints DESC\n")),(0,i.kt)("p",null,"Result:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-response"},"Query id: 8cdcdfd4-908f-4be0-99e3-265722a2ab8d\n\n\u250c\u2500borough\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500complaints\u2500\u252c\u2500bar(count(), 0, 125000, 60)\u2500\u2500\u2510\n\u2502 BROOKLYN      \u2502      57947 \u2502 \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258b \u2502\n\u2502 MANHATTAN     \u2502      53025 \u2502 \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258d   \u2502\n\u2502 QUEENS        \u2502      44875 \u2502 \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258c       \u2502\n\u2502 BRONX         \u2502      44260 \u2502 \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258f       \u2502\n\u2502 STATEN ISLAND \u2502       8503 \u2502 \u2588\u2588\u2588\u2588                         \u2502\n\u2502 (null)        \u2502        383 \u2502 \u258f                            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n6 rows in set. Elapsed: 0.008 sec. Processed 208.99 thousand rows, 209.43 KB (27.14 million rows/s., 27.20 MB/s.)\n")),(0,i.kt)("h2",{id:"next-steps"},"Next Steps"),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"/AlgoliaDocsSelfCrawl/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-intro"},"A Practical Introduction to Sparse Primary Indexes in ClickHouse")," discusses the differences in ClickHouse indexing compared to traditional relational databases, how ClickHouse builds and uses a sparse primary index, and indexing best practices."))}u.isMDXComponent=!0}}]);